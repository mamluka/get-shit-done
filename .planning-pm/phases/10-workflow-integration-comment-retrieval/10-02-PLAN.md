---
phase: 10-workflow-integration-comment-retrieval
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - .claude/get-shit-done/workflows/complete-milestone.md
  - .claude/get-shit-done/workflows/notion-comments.md
  - .claude/commands/gsd/notion-comments.md
autonomous: false

must_haves:
  truths:
    - "After completing a milestone, user is prompted to upload planning docs to Notion"
    - "Accepting the prompt triggers Notion sync automatically without manual /gsd:sync-notion invocation"
    - "User can run /gsd:notion-comments to pull all open comments from synced Notion pages"
    - "Comments are grouped by theme with Claude identifying patterns across all comments"
    - "Themes are mapped to affected roadmap phases"
    - "Claude walks user through a triage discussion for each theme interactively"
    - "Triage results are saved as a dated .md file in the .planning/ folder"
  artifacts:
    - path: ".claude/get-shit-done/workflows/complete-milestone.md"
      provides: "Notion sync prompt after git tag creation"
      contains: "prompt_notion_sync"
    - path: ".claude/get-shit-done/workflows/notion-comments.md"
      provides: "Interactive comment triage workflow"
      contains: "triage_discussion"
    - path: ".claude/commands/gsd/notion-comments.md"
      provides: "Slash command entry point for /gsd:notion-comments"
      contains: "notion-comments"
  key_links:
    - from: ".claude/get-shit-done/workflows/complete-milestone.md"
      to: "bin/notion-sync.js sync"
      via: "CLI invocation after user confirms sync prompt"
      pattern: "notion-sync.js sync"
    - from: ".claude/get-shit-done/workflows/notion-comments.md"
      to: "bin/notion-sync.js comments"
      via: "CLI invocation to fetch comments as JSON"
      pattern: "notion-sync.js comments"
    - from: ".claude/get-shit-done/workflows/notion-comments.md"
      to: ".planning/notion-comments-YYYY-MM-DD.md"
      via: "Dated triage output file creation"
      pattern: "notion-comments-.*\\.md"
---

<objective>
Integrate Notion sync into the milestone completion workflow and build the interactive comment triage workflow that Claude uses to help users process stakeholder feedback.

Purpose: This closes the bidirectional feedback loop — planning docs go out to Notion (sync), stakeholder comments come back (comments), and the user triages them into actionable roadmap changes. This is the capstone of the v1.1 Notion Integration milestone.

Output: Updated `complete-milestone.md` workflow with sync prompt, new `notion-comments.md` interactive triage workflow, and `/gsd:notion-comments` command entry point.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.claude/get-shit-done/workflows/complete-milestone.md
@bin/notion-sync.js
@lib/notion/comment-retriever.js
@.planning/phases/10-workflow-integration-comment-retrieval/10-RESEARCH.md
@.planning/phases/10-workflow-integration-comment-retrieval/10-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Notion sync prompt to complete-milestone workflow</name>
  <files>.claude/get-shit-done/workflows/complete-milestone.md</files>
  <action>
Add a new step `prompt_notion_sync` to `complete-milestone.md` **between** the existing `git_tag` step and `git_commit_milestone` step. This placement ensures all milestone content is finalized before offering to push to Notion.

**New step content:**

```markdown
<step name="prompt_notion_sync">

Check if Notion integration is configured:

```bash
node -e "
const fs = require('fs');
const configPath = require('path').join(process.cwd(), '.planning', 'config.json');
try {
  const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
  const hasKey = config.notion && config.notion.api_key && config.notion.api_key.trim() !== '';
  console.log(JSON.stringify({ configured: hasKey }));
} catch (e) {
  console.log(JSON.stringify({ configured: false }));
}
"
```

**If Notion is NOT configured:** Skip this step silently. Do not prompt.

**If Notion IS configured:**

Present to user:

```
## Upload Planning Docs to Notion?

Your milestone planning docs are finalized and ready to share with stakeholders.

This will push all .planning/ markdown files to your Notion workspace:
- New files will create new pages
- Changed files will update existing pages
- Unchanged files will be skipped

Sync to Notion? (yes / skip)
```

AskUserQuestion and wait for response.

**If user says "yes" (or equivalent affirmative):**

Run the sync automatically:

```bash
node bin/notion-sync.js sync --cwd "$(pwd)"
```

Report the sync results to the user (created/updated/skipped counts from CLI output).

If sync errors occur, report them but do NOT fail the milestone completion. The sync is a best-effort convenience — the milestone is already tagged and archived.

**If user says "skip" (or equivalent negative):**

Print: `Skipped Notion sync. You can sync manually later with /gsd:sync-notion`

Continue to next step.

</step>
```

**Important placement rules:**
- AFTER `git_tag` step (milestone is tagged, all content finalized)
- BEFORE `git_commit_milestone` step (so the commit can include any sync state changes)
- The step is entirely optional and self-contained — its absence or failure does not affect milestone completion

Do NOT modify any other steps in the workflow. Only insert the new step.
  </action>
  <verify>
```bash
# Step exists in workflow
grep -q "prompt_notion_sync" .claude/get-shit-done/workflows/complete-milestone.md && echo "PASS: step exists" || echo "FAIL"

# Step is between git_tag and git_commit_milestone
node -e "
const fs = require('fs');
const content = fs.readFileSync('.claude/get-shit-done/workflows/complete-milestone.md', 'utf8');
const tagPos = content.indexOf('name=\"git_tag\"');
const syncPos = content.indexOf('name=\"prompt_notion_sync\"');
const commitPos = content.indexOf('name=\"git_commit_milestone\"');
console.log(tagPos < syncPos && syncPos < commitPos ? 'PASS: correct ordering' : 'FAIL: wrong ordering');
"

# Existing steps still present
grep -c 'step name=' .claude/get-shit-done/workflows/complete-milestone.md
```
  </verify>
  <done>
- `complete-milestone.md` contains a `prompt_notion_sync` step
- The step is positioned after `git_tag` and before `git_commit_milestone`
- Step checks for Notion config before prompting
- Step handles both "yes" and "skip" responses
- All existing steps remain unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Create notion-comments interactive triage workflow and command</name>
  <files>
    .claude/get-shit-done/workflows/notion-comments.md
    .claude/commands/gsd/notion-comments.md
  </files>
  <action>
**Part A: Create the command entry point at `.claude/commands/gsd/notion-comments.md`**

This is the slash command file that users invoke with `/gsd:notion-comments`:

```markdown
---
description: Pull and triage unresolved comments from synced Notion pages
---

Fetch all unresolved comments from Notion pages synced via /gsd:sync-notion, identify themes, map to roadmap phases, and walk through interactive triage.

<required_reading>
@.claude/get-shit-done/workflows/notion-comments.md
</required_reading>

Follow the workflow steps in notion-comments.md exactly.
```

**Part B: Create the workflow at `.claude/get-shit-done/workflows/notion-comments.md`**

Build a multi-step interactive workflow following GSD patterns (sequential steps with AskUserQuestion gates):

```markdown
<purpose>
Retrieve unresolved comments from synced Notion pages, identify themes across all feedback, map themes to affected roadmap phases, and walk the user through an interactive triage discussion. Saves results as a dated markdown file for historical reference.
</purpose>

<required_reading>
1. `.planning/ROADMAP.md`
2. `.planning/STATE.md`
</required_reading>

<process>

<step name="fetch_comments">

Fetch all unresolved comments from synced Notion pages:

```bash
node bin/notion-sync.js comments --cwd "$(pwd)"
```

Parse the JSON output between `---COMMENTS_JSON_START---` and `---COMMENTS_JSON_END---` markers.

If no comments found (total === 0):
```
No unresolved comments found on synced Notion pages.

This means either:
- No one has commented on your Notion pages yet
- All existing comments have been resolved in Notion

Nothing to triage. You're all clear!
```
Exit workflow.

If comments found, continue to next step.

</step>

<step name="cluster_themes">

Read `.planning/ROADMAP.md` to understand the project's phase structure.

Analyze all fetched comments and identify 2-5 themes. For each theme:
1. **Theme name** — Short descriptive label (e.g., "Authentication UX Concerns", "API Documentation Gaps")
2. **Comments** — Which comments belong to this theme (by discussion text)
3. **Affected phases** — Which roadmap phases are impacted by this feedback (reference phase numbers and names from ROADMAP.md)
4. **Severity** — How critical is this theme? (blocking / important / nice-to-have)

Present the themes to the user:

```
## Comment Themes

Found {N} unresolved comments across {M} pages, grouped into {T} themes:

### Theme 1: {Name}
**Severity:** {blocking/important/nice-to-have}
**Affected phases:** Phase {X} ({name}), Phase {Y} ({name})
**Comments ({count}):**
- "{comment text excerpt}" — {author}, {page title}
- "{comment text excerpt}" — {author}, {page title}

### Theme 2: {Name}
...

---

Review these themes? (yes / adjust grouping / skip triage)
```

AskUserQuestion and wait for response.

- **"yes":** Continue to triage_discussion
- **"adjust grouping":** Ask user what to change, regroup, re-present
- **"skip triage":** Save themes as-is to dated file (skip discussion), jump to save_results

</step>

<step name="triage_discussion">

For each theme, conduct an interactive triage discussion:

```
## Triage: Theme {N}/{Total} — {Theme Name}

**Severity:** {severity}
**Affected phases:** {phase list}
**Comments:**
{Full comment text for each comment in this theme}

---

**Triage options:**
1. **Accept** — Create a task/requirement for this feedback
2. **Defer** — Acknowledge but handle in a future milestone
3. **Dismiss** — Not actionable or already addressed
4. **Discuss** — Need to think about this more

Your decision? (accept / defer / dismiss / discuss)
```

AskUserQuestion for each theme.

For each decision, record:
- Theme name
- Decision (accept / defer / dismiss / discuss)
- User's notes (if they provide additional context)
- Action items (if accept: what specifically needs to change)

If user chooses "discuss": engage in brief back-and-forth conversation about the theme, then ask for final decision (accept/defer/dismiss).

After all themes are triaged, present summary:

```
## Triage Summary

| Theme | Decision | Action |
|-------|----------|--------|
| {name} | Accepted | {brief action} |
| {name} | Deferred | To milestone v{X} |
| {name} | Dismissed | {reason} |

Save these results? (yes / revise)
```

AskUserQuestion. If "revise": let user change specific decisions, then re-present.

</step>

<step name="save_results">

Generate a dated triage output file.

**Filename:** `.planning/notion-comments-{YYYY-MM-DD}.md` where the date is today's date (ISO 8601 format).

**If file already exists for today:** Append a counter, e.g., `notion-comments-2026-02-11-2.md`

**File content template:**

```markdown
# Notion Comment Triage — {YYYY-MM-DD}

**Source:** {N} unresolved comments from {M} synced Notion pages
**Triaged by:** User + Claude
**Date:** {YYYY-MM-DD}

## Themes

### Theme 1: {Name}
**Decision:** {Accept / Defer / Dismiss}
**Severity:** {blocking / important / nice-to-have}
**Affected Phases:** Phase {X} ({name}), Phase {Y} ({name})
**Action:** {What needs to happen, or "Deferred to v{X}" or "Dismissed: {reason}"}

**Comments:**
- "{full comment text}" — {author} on {page title} ({date})
- "{full comment text}" — {author} on {page title} ({date})

### Theme 2: {Name}
...

## Summary

| Theme | Decision | Severity | Affected Phases |
|-------|----------|----------|-----------------|
| {name} | {decision} | {severity} | {phases} |

## Accepted Actions

{If any themes were accepted, list specific action items here:}

- [ ] {Action item from Theme 1}
- [ ] {Action item from Theme 2}

## Deferred Items

{If any themes were deferred:}

- {Theme name} — Deferred to {milestone/reason}

---
*Generated by /gsd:notion-comments on {YYYY-MM-DD}*
```

Write the file and commit:

```bash
node ./.claude/get-shit-done/bin/gsd-tools.js commit "docs(10): save notion comment triage results" --files .planning/notion-comments-{date}.md
```

Present result:

```
Triage results saved to .planning/notion-comments-{date}.md

{If any accepted themes:}
Next steps for accepted items:
- Add requirements to next milestone via /gsd:new-milestone
- Or create quick tasks via /gsd:quick

{If all dismissed/deferred:}
All feedback triaged — nothing requires immediate action.
```

</step>

</process>

<success_criteria>
- [ ] Comments fetched from all synced Notion pages
- [ ] Comments grouped into 2-5 meaningful themes
- [ ] Each theme mapped to affected roadmap phases
- [ ] User walked through triage discussion for each theme
- [ ] Dated .md file saved with full triage results
- [ ] File committed to git
</success_criteria>
```

**Important:** The workflow uses sequential prompts with AskUserQuestion at each decision point — it does NOT spawn subagents or use the Task tool. This matches the established GSD interactive pattern used in complete-milestone, new-project, and other workflow files.
  </action>
  <verify>
```bash
# Command file exists
test -f .claude/commands/gsd/notion-comments.md && echo "PASS: command exists" || echo "FAIL"

# Workflow file exists
test -f .claude/get-shit-done/workflows/notion-comments.md && echo "PASS: workflow exists" || echo "FAIL"

# Workflow has all required steps
for step in fetch_comments cluster_themes triage_discussion save_results; do
  grep -q "name=\"$step\"" .claude/get-shit-done/workflows/notion-comments.md && echo "PASS: $step step exists" || echo "FAIL: $step missing"
done

# Command references workflow
grep -q "notion-comments.md" .claude/commands/gsd/notion-comments.md && echo "PASS: command refs workflow" || echo "FAIL"

# Workflow references CLI tool
grep -q "notion-sync.js comments" .claude/get-shit-done/workflows/notion-comments.md && echo "PASS: workflow uses CLI" || echo "FAIL"

# Workflow mentions dated output file
grep -q "notion-comments-" .claude/get-shit-done/workflows/notion-comments.md && echo "PASS: dated output" || echo "FAIL"
```
  </verify>
  <done>
- `/gsd:notion-comments` command file exists and references the workflow
- Workflow has 4 steps: fetch_comments, cluster_themes, triage_discussion, save_results
- fetch_comments calls `node bin/notion-sync.js comments` to get structured data
- cluster_themes groups comments by theme and maps to roadmap phases
- triage_discussion walks user through each theme with accept/defer/dismiss/discuss options
- save_results writes dated .md file and commits to git
- Workflow uses AskUserQuestion pattern (not subprocess spawning)
  </done>
</task>

</tasks>

<verification>
1. `complete-milestone.md` has `prompt_notion_sync` step positioned after `git_tag` and before `git_commit_milestone`
2. `notion-comments.md` workflow exists with all 4 steps
3. `/gsd:notion-comments` command entry point exists
4. Workflow fetches comments via CLI, not direct API calls
5. Triage output uses dated filename (notion-comments-YYYY-MM-DD.md)
6. All existing complete-milestone steps remain unchanged
</verification>

<success_criteria>
- Milestone completion workflow prompts for Notion sync (WKFL-01, WKFL-02)
- Comment triage workflow fetches, clusters, maps, triages, and saves (CMNT-01 through CMNT-05)
- Interactive pattern matches GSD conventions (AskUserQuestion, not subprocess)
</success_criteria>

<output>
After completion, create `.planning/phases/10-workflow-integration-comment-retrieval/10-02-SUMMARY.md`
</output>
