---
phase: 10-workflow-integration-comment-retrieval
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/notion/comment-retriever.js
  - bin/notion-sync.js
autonomous: true

must_haves:
  truths:
    - "User can fetch all unresolved comments from synced Notion pages via CLI"
    - "Stale or deleted pages are skipped gracefully with warnings (not fatal errors)"
    - "Comments include source page context (file path, page title) for downstream grouping"
  artifacts:
    - path: "lib/notion/comment-retriever.js"
      provides: "Paginated comment retrieval from synced Notion pages"
      exports: ["retrieveComments", "extractCommentText"]
    - path: "bin/notion-sync.js"
      provides: "CLI comments subcommand"
      contains: "handleComments"
  key_links:
    - from: "lib/notion/comment-retriever.js"
      to: "lib/notion/sync-state.js"
      via: "loadSyncState to get synced page IDs"
      pattern: "loadSyncState|getPageId|doc_pages"
    - from: "lib/notion/comment-retriever.js"
      to: "lib/notion/page-manager.js"
      via: "validatePageExists for stale page detection"
      pattern: "validatePageExists"
    - from: "bin/notion-sync.js"
      to: "lib/notion/comment-retriever.js"
      via: "require and call retrieveComments"
      pattern: "retrieveComments"
---

<objective>
Build the comment retrieval module and CLI subcommand that fetches all unresolved comments from Notion pages tracked in notion-sync.json.

Purpose: This is the data layer for the comment triage workflow (Plan 02). Without reliable comment fetching, theme clustering and interactive triage have nothing to work with.

Output: `lib/notion/comment-retriever.js` module and `comments` CLI subcommand in `bin/notion-sync.js`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@lib/notion/client.js
@lib/notion/sync-state.js
@lib/notion/page-manager.js
@bin/notion-sync.js
@.planning/phases/10-workflow-integration-comment-retrieval/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comment-retriever.js module with paginated comment fetching</name>
  <files>lib/notion/comment-retriever.js</files>
  <action>
Create `lib/notion/comment-retriever.js` with two exported functions:

**`async retrieveComments(notion, options)`**

Parameters:
- `notion` — Notion SDK client instance
- `options.cwd` — Working directory (for loading sync state)
- `options.projectSlug` — Project slug (default: 'default')
- `options.onProgress` — Optional callback `({ pageFile, status, index, total, commentCount?, error? })` for UI feedback

Algorithm:
1. Load sync state via `loadSyncState(cwd)` from `../notion/sync-state.js`
2. Get project state via `getProjectState(state, projectSlug)`
3. If no project state or no `doc_pages`, return `{ comments: [], pages: 0, errors: [] }`
4. Build page list from `doc_pages` — extract all entries with page IDs (use `getPageId` for backward compatibility with both string and object formats)
5. For each page in the list:
   a. Call `validatePageExists(notion, pageId)` from `../notion/page-manager.js`
   b. If page doesn't exist (deleted/unauthorized): emit progress with status 'skipped', add to errors array with reason, continue to next page
   c. If page exists: call `fetchPageComments(notion, pageId)` (internal helper)
   d. Emit progress with status 'fetched' and commentCount
   e. Attach `filePath` and page title (from validatePageExists response `page.properties.title`) to each comment for source tracking
6. Return `{ comments: [...], pages: successCount, skipped: skipCount, errors: [...] }`

**Internal helper: `async fetchPageComments(notion, pageId)`**

Implements cursor-based pagination per Notion API:
```javascript
const comments = [];
let cursor = undefined;
while (true) {
  const response = await notion.comments.list({
    block_id: pageId,
    start_cursor: cursor,
    page_size: 100
  });
  comments.push(...response.results);
  if (!response.has_more) break;
  cursor = response.next_cursor;
}
return comments;
```

**`extractCommentText(comment)`**

Utility function that extracts plain text from a Notion comment object:
- Iterates over `comment.rich_text` array
- Concatenates `item.text.content` (or `item.plain_text`) for each rich text element
- Returns the full text string
- Returns empty string if no rich_text

**Error handling:**
- Individual page errors (403 for missing comment permissions, 404 for deleted pages) are captured in errors array, not thrown
- Network errors during pagination are caught and added to errors array for that page
- The function never throws — always returns a result object
- Wrap `notion.comments.list()` in try/catch. If 403 Forbidden, add error: "Missing read comment permission. Grant 'Read comments' in Notion integration settings at https://www.notion.so/my-integrations"

**Module pattern:** Follow existing codebase conventions:
- CommonJS `require` / `module.exports`
- JSDoc comments with @param and @returns
- Import from relative paths: `require('./sync-state.js')`, `require('./page-manager.js')`
  </action>
  <verify>
```bash
# Module loads without errors
node -e "const cr = require('./lib/notion/comment-retriever.js'); console.log(typeof cr.retrieveComments, typeof cr.extractCommentText)"
# Should output: function function

# extractCommentText works on mock comment object
node -e "
const { extractCommentText } = require('./lib/notion/comment-retriever.js');
const mock = { rich_text: [{ type: 'text', text: { content: 'Hello' } }, { type: 'text', text: { content: ' World' } }] };
console.log(extractCommentText(mock));
"
# Should output: Hello World

# extractCommentText handles empty rich_text
node -e "
const { extractCommentText } = require('./lib/notion/comment-retriever.js');
console.log(extractCommentText({ rich_text: [] }));
console.log(extractCommentText({}));
"
# Should output two empty strings
```
  </verify>
  <done>
- `lib/notion/comment-retriever.js` exists and exports `retrieveComments` and `extractCommentText`
- `extractCommentText` correctly extracts plain text from Notion comment objects
- Module loads without errors and follows codebase conventions (CommonJS, JSDoc, sync-state integration)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comments subcommand to notion-sync.js CLI</name>
  <files>bin/notion-sync.js</files>
  <action>
Extend `bin/notion-sync.js` to add a `comments` subcommand that fetches and displays all unresolved comments from synced pages.

**Changes to `printHelp()`:**
Add to the Commands section:
```
  comments         Fetch unresolved comments from synced Notion pages
```

Add to Examples section:
```
  node bin/notion-sync.js comments                         # Fetch all comments
  node bin/notion-sync.js comments --project my-project    # Fetch for specific project
```

**Add import at top of file (after existing requires):**
```javascript
const { retrieveComments, extractCommentText } = require('../lib/notion/comment-retriever.js');
```

**Create `handleComments(options)` function:**

Parameters: `{ cwd, projectSlug }`

Algorithm:
1. Create Notion client via `createNotionClient(cwd)`
2. Print header: `"Fetching comments from synced Notion pages...\n"`
3. Call `retrieveComments(notion, { cwd, projectSlug, onProgress })` with progress callback
4. Progress callback prints per-page status:
   - Green bullet for 'fetched' with comment count: `"● Fetched  {filePath} — {commentCount} comments ({index}/{total})"`
   - Dim bullet for 'skipped': `"○ Skipped  {filePath} — {error} ({index}/{total})"`
   - Red bullet for 'error': `"✗ Error    {filePath} — {error} ({index}/{total})"`
5. After retrieval, print summary line: `"\n✓ Found {N} comments across {M} pages ({skipped} skipped, {errors} errors)"`
6. If no comments found: print `"No unresolved comments found on synced pages."` and exit 0
7. If comments found: output JSON to stdout for downstream consumption by the workflow:
   ```javascript
   const output = {
     total: comments.length,
     pages: result.pages,
     comments: comments.map(c => ({
       id: c.id,
       discussion_id: c.discussion_id,
       text: extractCommentText(c),
       created_time: c.created_time,
       created_by: c.created_by?.name || c.created_by?.id || 'Unknown',
       source_file: c.filePath,
       source_page_title: c.pageTitle || null
     }))
   };
   console.log('\n---COMMENTS_JSON_START---');
   console.log(JSON.stringify(output, null, 2));
   console.log('---COMMENTS_JSON_END---');
   ```
8. Exit 0 on success, exit 1 on fatal errors (e.g., no config, auth failure)

**Add routing in `main()`:**
After the `if (command === 'sync')` block, add:
```javascript
if (command === 'comments') {
  await handleComments({ cwd, projectSlug });
  return;
}
```

**Error handling:**
- Auth errors from `createNotionClient()`: print actionable message and exit 1
- No synced pages: print info message and exit 0
  </action>
  <verify>
```bash
# Help shows comments subcommand
node bin/notion-sync.js help 2>&1 | grep -q "comments" && echo "PASS: comments in help" || echo "FAIL"

# Comments command without config gives actionable error
node bin/notion-sync.js comments --cwd /tmp 2>&1 | grep -qi "config\|error" && echo "PASS: error without config" || echo "FAIL"

# Module integration — all imports resolve
node -e "
const ns = require('fs').readFileSync('bin/notion-sync.js', 'utf8');
console.log(ns.includes('handleComments') ? 'PASS: handleComments exists' : 'FAIL');
console.log(ns.includes('comment-retriever') ? 'PASS: comment-retriever imported' : 'FAIL');
"
```
  </verify>
  <done>
- `node bin/notion-sync.js help` lists the `comments` subcommand with description and examples
- `node bin/notion-sync.js comments` attempts to fetch comments (fails gracefully without Notion config)
- CLI outputs progress per page and structured JSON for downstream workflow consumption
- All existing subcommands (auth-check, convert, sync) still work unchanged
  </done>
</task>

</tasks>

<verification>
1. `lib/notion/comment-retriever.js` exists, loads without errors, exports `retrieveComments` and `extractCommentText`
2. `extractCommentText` correctly parses Notion rich_text arrays into plain text strings
3. `bin/notion-sync.js help` shows comments subcommand
4. `node bin/notion-sync.js comments --cwd /tmp` fails gracefully with config error (not crash)
5. All existing CLI subcommands (auth-check, convert, sync) still function
</verification>

<success_criteria>
- Comment retriever module provides paginated fetching with stale page handling
- CLI comments subcommand outputs structured JSON suitable for workflow consumption
- No regressions in existing notion-sync.js functionality
</success_criteria>

<output>
After completion, create `.planning/phases/10-workflow-integration-comment-retrieval/10-01-SUMMARY.md`
</output>
