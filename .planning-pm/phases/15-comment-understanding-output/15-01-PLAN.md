---
phase: 15-comment-understanding-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/workflows/notion-comments.md
autonomous: true

must_haves:
  truths:
    - "After comments are fetched, user sees plain-language interpretation of each comment grouped by source file (Notion page title)"
    - "Each interpretation shows original comment text, commenter name, and Claude's understanding of intent"
    - "When interpretation output is short (<1500 tokens), it is presented inline in the conversation"
    - "When interpretation output is long (>=1500 tokens), it is saved to .planning/notion-comments-{date}.md and user is told to read the file"
    - "Existing theme clustering and triage steps still function after interpretation is presented"
  artifacts:
    - path: "get-shit-done/workflows/notion-comments.md"
      provides: "Updated workflow with interpret_comments step and smart output routing"
      contains: "interpret_comments"
  key_links:
    - from: "get-shit-done/workflows/notion-comments.md step interpret_comments"
      to: "fetch_comments JSON output"
      via: "Parses source_page_title and groups comments by page"
      pattern: "source_page_title"
    - from: "get-shit-done/workflows/notion-comments.md step interpret_comments"
      to: "output routing (inline vs file)"
      via: "Token estimation and threshold check"
      pattern: "1500 tokens"
---

<objective>
Add comment interpretation and smart output handling to the notion-comments workflow.

Purpose: Transform raw Notion comments from opaque JSON into plain-language interpretations that users can immediately understand, grouped by source file. When output is too long for conversation, automatically save to a file instead.

Output: Updated `get-shit-done/workflows/notion-comments.md` workflow file with new `interpret_comments` step inserted between `fetch_comments` and `cluster_themes`, plus output routing logic.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@get-shit-done/workflows/notion-comments.md
@bin/notion-sync.js
@lib/notion/comment-retriever.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add interpret_comments step with source-file grouping</name>
  <files>get-shit-done/workflows/notion-comments.md</files>
  <action>
Insert a new `<step name="interpret_comments">` between the existing `fetch_comments` and `cluster_themes` steps in the workflow file.

This new step instructs Claude to:

1. **Group comments by source file** using the `source_page_title` field from the JSON output. Each group is a section headed by the Notion page title. If `source_page_title` is null, use `source_file` path as fallback.

2. **For each comment in each group, produce an interpretation block** with this format:
   ```
   > "{original comment text}" — {created_by}, {created_time formatted as YYYY-MM-DD}
   >
   > **Intent:** {Claude's plain-language interpretation of what the commenter means and what they're asking for}
   ```

3. **Present all groups** under a heading like:
   ```
   ## Comment Interpretation

   Found {N} comments across {M} pages.

   ### {Page Title 1}

   > "{comment text}" — Author, 2026-02-12
   >
   > **Intent:** The commenter is asking for...

   > "{comment text}" — Author, 2026-02-12
   >
   > **Intent:** The commenter wants to...

   ### {Page Title 2}
   ...
   ```

The step should be self-contained instructions that Claude follows when executing the workflow. Reference the JSON structure fields: `text`, `created_by`, `created_time`, `source_page_title`, `source_file`.

Do NOT modify the existing `fetch_comments`, `cluster_themes`, `triage_discussion`, or `save_results` steps — only insert the new step between `fetch_comments` and `cluster_themes`.
  </action>
  <verify>
Verify the workflow file contains:
- A `<step name="interpret_comments">` element
- The step appears after `fetch_comments` and before `cluster_themes`
- The step references `source_page_title` for grouping
- The step includes interpretation format with original text, commenter name, and intent
- All 4 original steps (`fetch_comments`, `cluster_themes`, `triage_discussion`, `save_results`) are still present and unchanged
  </verify>
  <done>
The notion-comments workflow has 5 steps (fetch_comments, interpret_comments, cluster_themes, triage_discussion, save_results). The interpret_comments step groups comments by page title and produces plain-language interpretations showing original text, commenter, and Claude's understanding of intent.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add smart output routing (inline vs file) to interpret_comments step</name>
  <files>get-shit-done/workflows/notion-comments.md</files>
  <action>
Extend the `interpret_comments` step (created in Task 1) to include output routing logic at the end of the step.

Add the following output routing instructions to the interpret_comments step:

**Token estimation:** After composing the full interpretation output, estimate its length. Use a simple heuristic: count the total characters in the interpretation text and divide by 4 to approximate token count (1 token ≈ 4 characters is a standard approximation).

**Routing logic:**
- **If estimated tokens < 1500:** Present the interpretation directly in the conversation (inline). No file is created.
- **If estimated tokens >= 1500:** Save the interpretation to `.planning/notion-comments-{YYYY-MM-DD}.md` (using today's date in ISO 8601 format). If the file already exists for today, append a counter (e.g., `notion-comments-2026-02-12-2.md`). Tell the user: "Comment interpretation saved to `.planning/notion-comments-{date}.md` — read the file for full details." Then present a brief summary inline: total comment count, page count, and a one-line-per-page overview (page title + comment count).

**Important:** This output routing applies ONLY to the interpretation output. The existing `save_results` step at the end of the workflow (which saves triage results) remains completely unchanged. The interpretation file and the triage results file are separate concerns — interpretation is the raw understanding, triage results are the user's decisions.

**File format when saving:** Use the same markdown format as shown in the inline presentation (headings by page title, blockquote interpretations), but add a frontmatter header:
```markdown
# Notion Comment Interpretation — {YYYY-MM-DD}

**Source:** {N} comments from {M} pages
**Generated:** {YYYY-MM-DD}

## {Page Title 1}
...
```

After either path (inline or file), the workflow continues to the `cluster_themes` step as before.
  </action>
  <verify>
Verify the workflow file's `interpret_comments` step contains:
- Character count / token estimation logic (characters ÷ 4)
- A threshold check against 1500 tokens
- Instructions for inline presentation when under threshold
- Instructions for file creation when over threshold (with date format and counter logic)
- The `save_results` step remains unmodified
- The flow continues to `cluster_themes` after interpretation regardless of output path
  </verify>
  <done>
The interpret_comments step includes smart output routing: under 1500 tokens presents inline, over 1500 tokens saves to `.planning/notion-comments-{date}.md` with a brief inline summary. The existing save_results step for triage output is untouched. Both inline and file paths flow into cluster_themes.
  </done>
</task>

</tasks>

<verification>
1. Read `get-shit-done/workflows/notion-comments.md` and confirm it has exactly 5 steps in order: fetch_comments, interpret_comments, cluster_themes, triage_discussion, save_results
2. Confirm the interpret_comments step groups by `source_page_title` (with `source_file` fallback)
3. Confirm each interpretation includes: original comment text in blockquote, commenter name, date, and Claude's intent interpretation
4. Confirm output routing: token estimation (chars/4), threshold at 1500, inline vs file paths
5. Confirm file output path is `.planning/notion-comments-{YYYY-MM-DD}.md` with counter for duplicates
6. Confirm all original steps (fetch_comments, cluster_themes, triage_discussion, save_results) are unchanged
</verification>

<success_criteria>
- The notion-comments workflow has an `interpret_comments` step that transforms raw comment data into grouped, interpreted output
- Comments are grouped by Notion page title (CINT-02)
- Each comment shows original text, commenter, and plain-language intent interpretation (CINT-01, CINT-03)
- Output under 1500 tokens is presented inline (OUTP-02)
- Output over 1500 tokens is saved to a dated file with brief inline summary (OUTP-01)
- All existing workflow steps continue to function
</success_criteria>

<output>
After completion, create `.planning/phases/15-comment-understanding-output/15-01-SUMMARY.md`
</output>
