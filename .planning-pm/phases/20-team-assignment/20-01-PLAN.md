---
phase: 20-team-assignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/jira/team-fetcher.js
  - get-shit-done/workflows/sync-jira.md
autonomous: false

must_haves:
  truths:
    - "User sees list of Jira project team members with names and account IDs"
    - "User can assign epic to self or a team member"
    - "User can assign tickets to team members (bulk or individual)"
    - "Assignments are reflected in Jira after sync completes"
  artifacts:
    - path: "lib/jira/team-fetcher.js"
      provides: "Team member fetching and display formatting"
      exports: ["fetchAssignableUsers", "formatTeamList", "parseAssignmentChoice"]
    - path: "get-shit-done/workflows/sync-jira.md"
      provides: "Team assignment step in sync workflow"
      contains: "assign_team"
  key_links:
    - from: "get-shit-done/workflows/sync-jira.md"
      to: "mcp__jira__lookupJiraAccountId"
      via: "MCP tool call in assign_team step"
      pattern: "mcp__jira__lookupJiraAccountId"
    - from: "get-shit-done/workflows/sync-jira.md"
      to: "mcp__jira__editJiraIssue"
      via: "MCP tool call to set assignee field"
      pattern: "mcp__jira__editJiraIssue"
    - from: "get-shit-done/workflows/sync-jira.md"
      to: "lib/jira/team-fetcher.js"
      via: "Node require for formatting functions"
      pattern: "require.*team-fetcher"
---

<objective>
Add team member retrieval and assignment to the Jira sync workflow, enabling users to assign the epic and tickets to project team members.

Purpose: Completes TEAM-01, TEAM-02, TEAM-03 requirements — the team assignment capability in the v1.4 Jira Sync milestone. After tickets are created in Jira, users should be able to assign them to team members for workload distribution.

Output: `lib/jira/team-fetcher.js` module + extended `sync-jira.md` workflow with assignment step
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-epic-ticket-creation/19-01-SUMMARY.md
@lib/jira/issue-creator.js
@get-shit-done/workflows/sync-jira.md
@commands/gsd-pm/sync-jira.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create team-fetcher module for assignable user retrieval and display</name>
  <files>lib/jira/team-fetcher.js</files>
  <action>
Create `lib/jira/team-fetcher.js` following the same module pattern as `lib/jira/issue-creator.js` (CommonJS, JSDoc headers, same code style conventions — 2-space indent, semicolons, camelCase functions, snake_case JSON keys).

The module exports three functions:

**1. `fetchAssignableUsers(cloudId, projectKey)`**
- Returns an object structure that the workflow will use to display team members.
- This function does NOT call MCP directly — it returns instructions for the workflow to call MCP. Following the same pattern as `createEpicAndTickets` in issue-creator.js which prepares instructions rather than making direct calls.
- Returns: `{ tool: "mcp__jira__lookupJiraAccountId", params: { cloudId, query: "" } }` — an empty query returns all visible users for the cloud instance.
- NOTE: The actual MCP call happens in the workflow step, not in this JS module. The workflow will call `mcp__jira__lookupJiraAccountId` with `cloudId` and an empty `query` string to get available users. The response returns a list of users with `accountId` and `displayName` fields.

**2. `formatTeamList(users)`**
- Takes an array of user objects (each with `accountId` and `displayName` at minimum).
- Returns a formatted string for terminal display:
  ```
  Team Members:

  1. Alice Smith (alice.smith)
  2. Bob Jones (bob.jones)
  3. Charlie Brown (charlie.brown)
  ```
- The parenthetical shows a shortened identifier: if user has `emailAddress`, show the local part before @; otherwise show the first 12 chars of `accountId`.
- Returns the formatted string.

**3. `parseAssignmentChoice(input, userCount, ticketCount)`**
- Parses user input for the assignment prompt. Handles these formats:
  - `"skip"` — returns `{ action: "skip" }`
  - `"all:{N}"` — bulk assign all tickets to user N, returns `{ action: "bulk", userIndex: N }`
  - `"{ticketNum}:{userNum}"` — individual assignment, returns `{ action: "individual", assignments: [{ ticketIndex, userIndex }] }`
  - Multiple individual assignments separated by commas: `"1:2, 3:1, 4:2"` — returns `{ action: "individual", assignments: [...] }`
- Validates that user indices are within 1..userCount and ticket indices within 1..ticketCount.
- Returns `{ error: "message" }` if input is invalid.

Keep the module focused — under 120 lines. Follow the JSDoc style from issue-creator.js (file header comment, per-function JSDoc with @param and @returns).
  </action>
  <verify>
```bash
node -e "var tf = require('./lib/jira/team-fetcher.js'); console.log(Object.keys(tf));"
```
Should output: `[ 'fetchAssignableUsers', 'formatTeamList', 'parseAssignmentChoice' ]`

```bash
node -e "
var tf = require('./lib/jira/team-fetcher.js');
// Test formatTeamList
var users = [{displayName:'Alice Smith', accountId:'abc123', emailAddress:'alice@example.com'},{displayName:'Bob Jones', accountId:'def456'}];
console.log(tf.formatTeamList(users));
// Test parseAssignmentChoice
console.log(JSON.stringify(tf.parseAssignmentChoice('skip', 2, 5)));
console.log(JSON.stringify(tf.parseAssignmentChoice('all:1', 2, 5)));
console.log(JSON.stringify(tf.parseAssignmentChoice('1:2, 3:1', 2, 5)));
console.log(JSON.stringify(tf.parseAssignmentChoice('all:5', 2, 5)));
"
```
Should show: formatted team list, `{"action":"skip"}`, `{"action":"bulk","userIndex":1}`, individual assignments object, and error for invalid user index.
  </verify>
  <done>
lib/jira/team-fetcher.js exists with fetchAssignableUsers, formatTeamList, and parseAssignmentChoice exported. All three functions work correctly for valid and invalid inputs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add team assignment step to sync-jira workflow</name>
  <files>get-shit-done/workflows/sync-jira.md</files>
  <action>
Extend the sync-jira workflow by adding a new step `assign_team` between the existing `create_tickets` step and `save_sync_state` step. The current workflow has steps: check_jira_mcp, check_notion_sync, select_jira_project, save_jira_config, choose_granularity, preview_and_approve, create_tickets, save_sync_state. After this change it will have 9 steps, with `assign_team` as the new step 8 and `save_sync_state` becoming step 9.

**New step `assign_team`:**

After the completion banner from create_tickets, add:

1. **Prompt for assignment.** Use `AskUserQuestion` to ask:
   ```
   Would you like to assign the epic and tickets to team members?
   - Yes
   - No, skip assignment
   ```
   If user selects "No": display `Skipping team assignment.` and continue to save_sync_state.

2. **Fetch assignable users.** If user selects "Yes":
   - Call `mcp__jira__lookupJiraAccountId` with `cloudId` = CLOUD_ID and `query` = "" (empty string to get all available users).
   - The response contains an array of user objects, each with at minimum `accountId` and `displayName`.
   - If no users returned or the call fails, display: `No assignable users found for this project. Skipping assignment.` and continue to save_sync_state.

3. **Display team member list.** Call team-fetcher to format the list:
   ```bash
   TEAM_LIST=$(node -e '
   var tf = require("./lib/jira/team-fetcher.js");
   var users = JSON.parse(process.argv[1]);
   console.log(tf.formatTeamList(users));
   ' "$USERS_JSON")
   ```
   Display the formatted team list.

4. **Epic assignment.** Use `AskUserQuestion` to prompt:
   ```
   Assign epic ({epic_key}) to a team member?

   Enter member number (1-{N}), or "skip" to leave unassigned:
   ```
   If user enters a valid number: call `mcp__jira__editJiraIssue` with `cloudId` = CLOUD_ID, `issueIdOrKey` = epic_key, and `assigneeAccountId` = the selected user's accountId. Display: `Assigned {epic_key} to {displayName}`.
   If user enters "skip": display `Epic assignment skipped.`

5. **Ticket assignment.** Use `AskUserQuestion` to prompt:
   ```
   Assign tickets to team members?

   Options:
   - "all:{N}"          — Assign ALL tickets to member N
   - "1:2, 3:1, 4:2"   — Assign specific tickets to specific members
   - "skip"             — Leave all tickets unassigned

   Enter assignment:
   ```
   Parse the response using team-fetcher's `parseAssignmentChoice`:
   ```bash
   CHOICE=$(node -e '
   var tf = require("./lib/jira/team-fetcher.js");
   var result = tf.parseAssignmentChoice(process.argv[1], {userCount}, {ticketCount});
   console.log(JSON.stringify(result));
   ' "$USER_INPUT")
   ```

   **If action is "skip":** Display `Ticket assignment skipped.`

   **If action is "bulk":** For each ticket key from step 7, call `mcp__jira__editJiraIssue` with `cloudId` = CLOUD_ID, `issueIdOrKey` = ticket_key, and `assigneeAccountId` = selected user's accountId. Display progress:
   ```
   Assigning all tickets to {displayName}...
   ✓ [{N}/{TICKET_COUNT}] {ticket_key} assigned
   ```

   **If action is "individual":** For each assignment pair, call `mcp__jira__editJiraIssue` with the corresponding ticket key and user accountId. Display per-assignment:
   ```
   ✓ {ticket_key} assigned to {displayName}
   ```

   **If error:** Display the error message and re-prompt (one retry, then skip on second failure).

6. **Assignment summary.** After all assignments processed, display:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    TEAM ASSIGNMENT COMPLETE
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   Epic: {epic_key} → {assignee or "unassigned"}
   Tickets assigned: {count}/{total}
   ```

**Update save_sync_state step:**

Extend the jira-sync.json data structure saved in the existing save_sync_state step to include assignment information. Add an `assignments` object:
```json
{
  "epic": {
    "key": "...",
    "summary": "...",
    "assignee": { "accountId": "...", "displayName": "..." }
  },
  "tickets": [
    {
      "key": "...",
      "summary": "...",
      "phase": "...",
      "assignee": { "accountId": "...", "displayName": "..." }
    }
  ]
}
```
If a ticket or epic was not assigned, omit the `assignee` field (do not include null).

**Important implementation notes:**
- The workflow step instructs Claude to call MCP tools directly (same pattern as create_tickets step) — these are Claude MCP tool calls, NOT bash commands.
- The `mcp__jira__editJiraIssue` tool is already in the command's allowed-tools list.
- `mcp__jira__lookupJiraAccountId` is already in the command's allowed-tools list.
- The team-fetcher.js module is called via bash/node for formatting and parsing only — the actual MCP calls are made by Claude in the workflow.
- Handle errors gracefully: if an assignment fails, log the error, continue with remaining assignments, and track failure count.
  </action>
  <verify>
Verify workflow structure:
```bash
grep -c '<step name=' get-shit-done/workflows/sync-jira.md
```
Should output: `9` (was 8, now includes assign_team)

```bash
grep 'step name="assign_team"' get-shit-done/workflows/sync-jira.md
```
Should match the new step.

```bash
grep 'mcp__jira__editJiraIssue' get-shit-done/workflows/sync-jira.md
```
Should match at least once (in the assignment step).

```bash
grep 'mcp__jira__lookupJiraAccountId' get-shit-done/workflows/sync-jira.md
```
Should match at least once (in the assignment step).

```bash
grep 'team-fetcher' get-shit-done/workflows/sync-jira.md
```
Should match (formatTeamList and parseAssignmentChoice references).

```bash
grep 'assignee' get-shit-done/workflows/sync-jira.md
```
Should match in the save_sync_state step update.
  </verify>
  <done>
sync-jira.md has 9 steps. New assign_team step prompts for assignment, fetches team members via mcp__jira__lookupJiraAccountId, supports epic assignment and ticket assignment (bulk or individual) via mcp__jira__editJiraIssue, displays assignment summary. save_sync_state step includes assignee data in jira-sync.json.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify team assignment end-to-end in Jira</name>
  <files>get-shit-done/workflows/sync-jira.md</files>
  <action>
Run `/gsd-pm:sync-jira` end-to-end and verify the complete team assignment pipeline works: team members are listed, epic can be assigned, tickets can be assigned (bulk and individual), and assignments appear in Jira.
  </action>
  <what-built>Full team assignment pipeline: team member listing, epic assignment, ticket assignment (bulk + individual), assignment state in jira-sync.json</what-built>
  <how-to-verify>
1. Run `/gsd-pm:sync-jira` end-to-end
2. After ticket creation completes, verify the assignment prompt appears
3. Test "No, skip assignment" path — should skip cleanly
4. Run again (or test in same flow): select "Yes" for assignment
5. Verify team member list displays with names
6. Test epic assignment: enter a member number, verify epic is assigned in Jira
7. Test ticket bulk assignment: enter "all:1", verify all tickets assigned in Jira
8. (Optional) Test individual assignment: enter "1:2, 2:1" format
9. Verify jira-sync.json includes assignee data after completion
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Phase-level checks after all tasks complete:

1. TEAM-01: `node -e "var tf = require('./lib/jira/team-fetcher.js'); console.log(typeof tf.formatTeamList)"` outputs "function"
2. TEAM-02: `grep 'assign epic' get-shit-done/workflows/sync-jira.md` (case-insensitive) matches assignment step
3. TEAM-03: `grep 'all:' get-shit-done/workflows/sync-jira.md` matches bulk assignment option
4. Workflow has 9 steps: `grep -c '<step name=' get-shit-done/workflows/sync-jira.md` outputs 9
5. Assignment step uses correct MCP tools: grep confirms mcp__jira__editJiraIssue and mcp__jira__lookupJiraAccountId references
</verification>

<success_criteria>
1. lib/jira/team-fetcher.js exists with 3 exported functions (fetchAssignableUsers, formatTeamList, parseAssignmentChoice)
2. sync-jira.md workflow has 9 steps (8 original + assign_team inserted before save_sync_state)
3. User can skip assignment entirely (skip path works)
4. User can assign epic to a team member via mcp__jira__editJiraIssue
5. User can bulk-assign all tickets to one member
6. User can individually assign tickets to different members
7. jira-sync.json includes assignee information when assignments are made
8. Human verification confirms assignments appear in Jira
</success_criteria>

<output>
After completion, create `.planning/phases/20-team-assignment/20-01-SUMMARY.md`
</output>
