---
phase: 19-epic-ticket-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/jira/issue-creator.js
  - get-shit-done/workflows/sync-jira.md
autonomous: false

must_haves:
  truths:
    - "Epic is created in Jira for the in-progress milestone as parent for all tickets"
    - "Tickets are created as children of the epic using the ticket-mapper output"
    - "Each ticket description includes a Notion page link pulled from notion-sync.json"
    - "Ticket descriptions include relevant planning content (requirements, success criteria, phase context)"
    - "User sees full ticket preview (epic + all tickets with descriptions) before any Jira API writes"
    - "User can approve or cancel the sync operation after viewing the preview"
  artifacts:
    - path: "lib/jira/issue-creator.js"
      provides: "Issue creation orchestration: epic creation, child ticket creation, Notion link embedding"
      exports: ["createEpicAndTickets", "buildPreview"]
      contains: "function createEpicAndTickets"
    - path: "get-shit-done/workflows/sync-jira.md"
      provides: "Extended workflow with preview+approve step and Jira creation step"
      contains: "create_tickets"
  key_links:
    - from: "lib/jira/issue-creator.js"
      to: "lib/jira/ticket-mapper.js"
      via: "consumes ticket-mapper output (tickets array with descriptions)"
      pattern: "tickets"
    - from: "lib/jira/issue-creator.js"
      to: "mcp__jira__createJiraIssue"
      via: "workflow calls MCP tool per ticket"
      pattern: "createJiraIssue"
    - from: "get-shit-done/workflows/sync-jira.md"
      to: "lib/jira/issue-creator.js"
      via: "inline node -e require() call in workflow step"
      pattern: "require.*issue-creator"
    - from: "get-shit-done/workflows/sync-jira.md"
      to: ".planning/config.json"
      via: "reads jira.cloud_id, jira.project_id, jira.project_key from config"
      pattern: "config-get jira"
---

<objective>
Create the issue creation module and extend the sync-jira workflow with a preview+approve gate and Jira API write steps that create an epic for the milestone and child tickets based on the ticket-mapper output.

Purpose: This is the core value delivery for v1.4 â€” actually pushing planning artifacts into Jira. Phase 18 produced the ticket data structures; this phase consumes them to create real Jira issues. The preview+approve pattern ensures the user has full control before any writes happen.

Output: `lib/jira/issue-creator.js` module + extended `sync-jira.md` workflow with steps 7-8 (preview+approve gate and Jira creation).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/17-jira-mcp-detection-prerequisites/17-01-SUMMARY.md
@.planning/phases/18-granularity-strategy-ticket-mapping/18-01-SUMMARY.md
@lib/jira/ticket-mapper.js
@get-shit-done/workflows/sync-jira.md
@commands/gsd/sync-jira.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create issue-creator module for epic and ticket creation</name>
  <files>lib/jira/issue-creator.js</files>
  <action>
Create `lib/jira/issue-creator.js` that exports two functions: `buildPreview(cwd, granularity)` and `createEpicAndTickets(cloudId, projectKey, epicKey, tickets, notionLinks)`.

The module must:

1. **`buildPreview(cwd, granularity)`** â€” Generates a structured preview object showing the user exactly what will be created in Jira before any writes happen.

   - Call `require('./ticket-mapper').mapTickets(cwd, granularity)` to get ticket data
   - If ticket-mapper returns an error, propagate it: `return { error: result.error }`
   - Load config to get project key: read `.planning/config.json` using multi-project-aware path resolution (same pattern as ticket-mapper.js `resolvePlanningPath`)
   - Load Notion links using the same `loadNotionLinks` pattern from ticket-mapper.js (or require ticket-mapper and use it if it exports that function â€” it doesn't currently, so duplicate the logic)
   - Build preview object:
     ```js
     {
       epic: {
         summary: "{milestone} â€” {project_key}",
         description: "Epic for {milestone} milestone. Contains {ticket_count} tickets at {granularity}-level granularity.",
         issue_type: "Epic"
       },
       tickets: result.tickets.map(t => ({
         summary: t.title,
         description: t.description,
         issue_type: "Task",
         notion_link: buildNotionUrl(t.notion_page_id),  // null if no page_id
         parent: "[epic key â€” assigned after creation]"
       })),
       milestone: result.milestone,
       granularity: result.granularity,
       ticket_count: result.ticket_count
     }
     ```
   - The `buildNotionUrl(pageId)` helper converts a Notion page ID to a URL: `https://www.notion.so/${pageId.replace(/-/g, '')}` if pageId exists, null otherwise

2. **`createEpicAndTickets(cloudId, projectKey, epicKey, tickets, notionLinks)`** â€” This function does NOT call MCP directly (MCP calls must happen in the workflow since they're tool calls). Instead, it prepares the creation payloads that the workflow will iterate over.

   Return an array of creation instructions:
   ```js
   {
     instructions: [
       {
         step: 'create_epic',
         tool: 'mcp__jira__createJiraIssue',
         params: {
           cloudId: cloudId,
           projectKey: projectKey,
           issueTypeName: 'Epic',
           summary: epicSummary,
           description: epicDescription
         }
       },
       // For each ticket:
       {
         step: 'create_ticket',
         index: N,
         tool: 'mcp__jira__createJiraIssue',
         params: {
           cloudId: cloudId,
           projectKey: projectKey,
           issueTypeName: 'Task',
           summary: ticket.title,
           description: ticketDescription,
           parent: null  // Will be set to epic key after epic creation
         }
       }
     ]
   }
   ```

   For TICK-03 (Notion page links): Embed the Notion link directly in each ticket's description. Prepend each ticket description with a "Notion Page" link line:
   ```
   **ğŸ“ Notion Page:** [View in Notion](https://www.notion.so/{pageIdWithoutDashes})

   {original description from ticket-mapper}
   ```
   Only add this line if the ticket has a `notion_page_id` field. If no Notion page ID is available, use the description as-is from ticket-mapper.

   For TICK-04 (planning content): The ticket-mapper already includes requirements, success criteria, and phase context in descriptions. No additional work needed â€” pass through as-is.

3. **`formatPreviewDisplay(preview)`** â€” Formats the preview object into a human-readable string for terminal display.

   Output format:
   ```
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    JIRA SYNC PREVIEW
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   Milestone: {milestone}
   Granularity: {granularity}-level
   Total: 1 epic + {ticket_count} tickets

   EPIC
     {epic.summary}
     {epic.description}

   TICKETS
     [1] {ticket.summary}
         {first 120 chars of description}...
         Notion: {notion_link or "â€”"}

     [2] {ticket.summary}
         ...
   ```

Follow existing codebase conventions:
- CommonJS `require()` / `module.exports`
- Zero external dependencies (Node.js built-ins only: `fs`, `path`)
- Synchronous file operations (matching existing lib/ pattern)
- JSDoc comments on all exported functions
- Graceful fallback: return `{ error: '...' }` not throw
- camelCase for functions

Important: The `createEpicAndTickets` function prepares instructions ONLY. Actual MCP tool calls happen in the workflow (step 8) because MCP tools are Claude tool calls, not Node.js function calls. The module's job is to structure the data; the workflow's job is to execute the MCP calls.
  </action>
  <verify>
Run: `node -e "const m = require('./lib/jira/issue-creator.js'); console.log(typeof m.buildPreview, typeof m.createEpicAndTickets, typeof m.formatPreviewDisplay)"` should output `function function function`.

Run: `node -e "const m = require('./lib/jira/issue-creator.js'); const p = m.buildPreview(process.cwd(), 'phase'); console.log(JSON.stringify({ has_epic: !!p.epic, ticket_count: p.ticket_count, has_tickets: Array.isArray(p.tickets) }))"` should output JSON with `has_epic: true`, valid `ticket_count`, and `has_tickets: true`.

Run: `node -e "const m = require('./lib/jira/issue-creator.js'); const p = m.buildPreview(process.cwd(), 'phase'); console.log(m.formatPreviewDisplay(p))"` should output a formatted preview string containing "JIRA SYNC PREVIEW" and ticket listings.
  </verify>
  <done>
`lib/jira/issue-creator.js` exists, exports `buildPreview`, `createEpicAndTickets`, and `formatPreviewDisplay`. `buildPreview` returns a preview object with epic info and ticket array. Each ticket description includes a Notion page link if available. `formatPreviewDisplay` renders a terminal-friendly preview string. `createEpicAndTickets` returns structured MCP call instructions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend sync-jira workflow with preview-approve gate and ticket creation steps</name>
  <files>get-shit-done/workflows/sync-jira.md</files>
  <action>
Extend `get-shit-done/workflows/sync-jira.md` by REPLACING step 6 (`map_tickets`) with an enhanced preview step, and adding two new steps after it. The existing step 6 only showed a basic preview and told the user to wait for Phase 19. Now Phase 19 is here, so step 6 becomes a full preview+approve gate, and step 7 performs the actual Jira creation.

**Step 6: `preview_and_approve` (REPLACES existing `map_tickets`)**

This step combines ticket mapping, full preview generation, and user approval:

1. First, read Jira config values saved in step 4:
```bash
CLOUD_ID=$(node ~/.claude/get-shit-done/bin/gsd-tools.js config-get jira.cloud_id)
PROJECT_KEY=$(node ~/.claude/get-shit-done/bin/gsd-tools.js config-get jira.project_key)
```

2. Call the issue-creator module to build a preview:
```bash
PREVIEW=$(node -e '
var creator = require("./lib/jira/issue-creator.js");
var result = creator.buildPreview(process.cwd(), "{granularity}");
if (result.error) {
  console.log(JSON.stringify({ error: result.error }));
} else {
  console.log(JSON.stringify(result));
}
')
```

3. If `error` field present, display the error and stop.

4. Call `formatPreviewDisplay` to render the preview:
```bash
DISPLAY=$(node -e '
var creator = require("./lib/jira/issue-creator.js");
var preview = JSON.parse(process.argv[1]);
console.log(creator.formatPreviewDisplay(preview));
' "$PREVIEW")
```

5. Display the formatted preview to the user.

6. Use `AskUserQuestion` to prompt:
```
Proceed with Jira sync? This will create 1 epic + {ticket_count} tickets in {PROJECT_KEY}.

Type "yes" to proceed or "cancel" to abort:
```

7. If user types anything other than "yes" (case-insensitive), display:
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 SYNC CANCELLED
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

No changes made to Jira. Run /gsd:sync-jira again to retry.
```
Stop.

8. If user types "yes", continue to step 7.

**Step 7: `create_tickets`**

This step performs the actual Jira API calls using MCP tools:

1. **Detect the Epic issue type name.** Different Jira projects may use different names for Epics. Call `mcp__jira__getJiraProjectIssueTypesMetadata` with the `cloudId` and `projectIdOrKey` to get available issue types. Find the issue type with name containing "Epic" (case-insensitive). If no Epic type found, display error and stop.

2. **Create the Epic.** Call `mcp__jira__createJiraIssue` with:
   - `cloudId`: from config
   - `projectKey`: from config
   - `issueTypeName`: The Epic type name found in step 1 (usually "Epic")
   - `summary`: The epic summary from the preview (e.g., "v1.4 Jira Sync â€” PROJ")
   - `description`: The epic description from the preview

   Extract the created epic's `key` from the response.

   Display:
   ```
   âœ“ Epic created: {epic_key} â€” {epic_summary}
   ```

3. **Create child tickets.** For each ticket in the preview's tickets array, call `mcp__jira__createJiraIssue` with:
   - `cloudId`: from config
   - `projectKey`: from config
   - `issueTypeName`: "Task" (or "Story" â€” use the first available standard type from the issue types metadata)
   - `summary`: ticket summary
   - `description`: ticket description (already includes Notion link if available)
   - `parent`: the epic key created in step 2

   After each ticket creation, display progress:
   ```
   âœ“ [{N}/{total}] {ticket_key} â€” {ticket_summary}
   ```

4. **Display completion banner:**
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 GSD â–º JIRA SYNC COMPLETE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ“ Created 1 epic + {ticket_count} tickets in {PROJECT_KEY}

  Epic: {epic_key}
  Tickets: {comma-separated list of ticket keys}
  Granularity: {granularity}-level

All planning artifacts are now in Jira.
```

**Important implementation notes:**

- Preserve steps 1-5 exactly as they are (from Phase 17 and 18). Only REPLACE step 6 and ADD step 7.
- Step 6 uses `AskUserQuestion` for the approve/cancel gate â€” this satisfies TICK-05 (preview before writes) and the "approve or cancel" success criterion.
- Step 7 uses `mcp__jira__createJiraIssue` tool calls â€” these are Claude MCP tool calls, NOT bash commands. The workflow instructs Claude to call these tools iteratively.
- Step 7 must call `mcp__jira__getJiraProjectIssueTypesMetadata` first to discover the correct issue type names for the target project, since different Jira instances may have different type configurations.
- The parent field on child tickets uses the epic key returned from epic creation (e.g., "PROJ-123"). This is the standard Jira next-gen/team-managed project pattern for linking children to epics.
- Error handling: If any ticket creation fails, display the error, continue with remaining tickets, and include failure count in the final banner.
- Match existing markdown workflow formatting: use `<step name="...">` XML tags, code blocks, conditional display blocks.
  </action>
  <verify>
Read `get-shit-done/workflows/sync-jira.md` and verify:
1. Steps 1-5 are unchanged from Phase 17/18
2. Step 6 (`preview_and_approve`) exists with buildPreview call, formatPreviewDisplay, AskUserQuestion approve/cancel gate
3. Step 7 (`create_tickets`) exists with epic creation via mcp__jira__createJiraIssue, child ticket creation loop, completion banner
4. Step 6 has clear cancel path that stops execution
5. Step 7 references mcp__jira__getJiraProjectIssueTypesMetadata for type discovery
6. All step names are unique
  </verify>
  <done>
The sync-jira workflow has 7 steps (5 from Phase 17/18 preserved, step 6 replaced with preview+approve gate, step 7 added for Jira creation). Step 6 builds and displays full preview with epic and tickets, then asks user to approve or cancel. Step 7 creates the epic first, then iterates over tickets creating each as a child of the epic. Notion links are embedded in ticket descriptions. Completion banner shows all created issue keys.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Jira sync end-to-end</name>
  <files>get-shit-done/workflows/sync-jira.md</files>
  <action>
Run `/gsd:sync-jira` end-to-end and verify the complete pipeline works: preview shows correctly, cancel aborts cleanly, and approve creates real Jira issues with correct parent-child relationships and Notion links.
  </action>
  <what-built>Full Jira sync pipeline: preview, approve/cancel gate, epic creation, child ticket creation with Notion links in descriptions</what-built>
  <how-to-verify>
1. Run `/gsd:sync-jira` end-to-end
2. Verify you see the full preview with epic + ticket list before any Jira writes
3. Type "cancel" to verify the abort path works (no changes to Jira)
4. Run again and type "yes" to verify:
   - Epic is created in your Jira project
   - Child tickets are created under the epic
   - Ticket descriptions include Notion page links and planning content
   - Completion banner shows all created issue keys
5. Check Jira to confirm the epic and tickets exist with correct parent-child relationships
  </how-to-verify>
  <verify>User confirms all Jira issues created correctly</verify>
  <done>Epic and child tickets visible in Jira with correct parent-child structure, Notion links in descriptions, and planning content present</done>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 19 verification checklist:
1. `lib/jira/issue-creator.js` exists and exports `buildPreview`, `createEpicAndTickets`, `formatPreviewDisplay`
2. `buildPreview` returns object with `epic`, `tickets`, `milestone`, `granularity`, `ticket_count`
3. Each ticket in preview includes `notion_link` URL when notion_page_id is available
4. `formatPreviewDisplay` renders a readable terminal preview
5. Workflow step 6 (`preview_and_approve`) shows full preview and prompts for approval
6. Workflow step 6 stops on cancel with clear messaging
7. Workflow step 7 (`create_tickets`) creates epic via `mcp__jira__createJiraIssue` with Epic type
8. Workflow step 7 creates child tickets with `parent` set to epic key
9. Ticket descriptions include Notion page link when available (TICK-03)
10. Ticket descriptions include planning content from ticket-mapper (TICK-04)
11. Steps 1-5 of workflow are preserved unchanged
</verification>

<success_criteria>
- TICK-01: Epic created per milestone via `mcp__jira__createJiraIssue` with `issueTypeName: "Epic"`
- TICK-02: Tickets created as children via `parent: "{epic_key}"` parameter
- TICK-03: Notion page URL embedded in ticket descriptions using notion_page_id from ticket-mapper
- TICK-04: Descriptions include requirements, success criteria, phase context (inherited from ticket-mapper)
- TICK-05: Full preview (epic + all tickets) displayed before any Jira writes, with approve/cancel gate
- Running `node -e "require('./lib/jira/issue-creator.js').buildPreview(process.cwd(), 'phase')"` produces preview with epic and tickets
- Workflow approve/cancel gate blocks all Jira writes until user explicitly approves
</success_criteria>

<output>
After completion, create `.planning/phases/19-epic-ticket-creation/19-01-SUMMARY.md`
</output>
