---
phase: 14-notion-sync-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/workflows/plan-phase.md
  - .planning/REQUIREMENTS.md
autonomous: true

must_haves:
  truths:
    - "After all phases in milestone are planned, user sees 'Sync planning docs to Notion?' prompt before completion message"
    - "Prompt only appears if Notion is properly configured (API key with secret_ or ntn_ prefix, parent page ID exists)"
    - "If user accepts sync, notion-sync.js runs and uploads .planning/ markdown files to Notion"
    - "Sync results are displayed (created/updated/skipped/failed) before showing final completion message"
    - "If Notion is not configured, prompt is skipped and user proceeds to completion message without interruption"
    - "Sync errors do not block milestone completion - user always sees completion message"
  artifacts:
    - path: "get-shit-done/workflows/plan-phase.md"
      provides: "Notion sync prompt step 14e between milestone detection and completion message"
      contains: "14e. Notion Sync Prompt"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Updated traceability for PLAN-03 and NOTION-04"
      contains: "PLAN-03"
  key_links:
    - from: "get-shit-done/workflows/plan-phase.md"
      to: "bin/notion-sync.js"
      via: "child process spawn in step 14e"
      pattern: "notion-sync.js sync"
    - from: "get-shit-done/workflows/plan-phase.md"
      to: ".planning/config.json"
      via: "inline node script reading config for pre-check"
      pattern: "config.notion.api_key"
---

<objective>
Add Notion sync prompt to plan-phase workflow that triggers after all milestone phases are planned.

Purpose: When all phases are planned and milestone_complete is true, users should be offered a seamless sync to Notion before seeing the completion message. This prevents the manual step of running /gsd:sync-notion separately and ensures stakeholders see planning docs promptly. An auth pre-check prevents showing the prompt when Notion is not configured.

Output: Modified plan-phase.md with step 14e (Notion sync prompt with pre-check), updated requirements traceability.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-notion-sync-integration/14-RESEARCH.md
@.planning/phases/13-auto-discuss-before-planning/13-01-SUMMARY.md
@get-shit-done/workflows/plan-phase.md
@get-shit-done/workflows/complete-milestone.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Notion sync prompt step 14e to plan-phase workflow</name>
  <files>get-shit-done/workflows/plan-phase.md</files>
  <action>
Insert a new step **14e** into plan-phase.md between step 14d's `milestone_complete === true` detection and the current "All Phases Complete" display. The current step 14d has two branches: `milestone_complete === true` (shows completion message + STOP) and `milestone_complete === false` (auto-advance). Step 14e is injected INTO the `milestone_complete === true` branch, BEFORE the completion message display.

**Restructure step 14d's milestone_complete === true branch as follows:**

Replace the current `milestone_complete === true` block (which immediately shows the completion message and STOPs) with:

1. **Step 14e: Notion Sync Prompt** (new sub-step within the milestone_complete === true branch)

   First, run a fast local pre-check (no network calls) to validate Notion configuration:

   ```bash
   NOTION_CHECK=$(node -e "
   const fs = require('fs');
   const path = require('path');
   const configPath = path.join(process.cwd(), '.planning', 'config.json');
   try {
     const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
     const hasKey = config.notion && config.notion.api_key && config.notion.api_key.trim() !== '';
     const validPrefix = hasKey && (config.notion.api_key.startsWith('secret_') || config.notion.api_key.startsWith('ntn_'));
     const hasParent = config.notion && config.notion.parent_page_id;
     console.log(JSON.stringify({
       configured: hasKey && validPrefix,
       has_parent: !!hasParent,
       reason: !hasKey ? 'no_api_key' : !validPrefix ? 'invalid_prefix' : 'valid'
     }));
   } catch (e) {
     console.log(JSON.stringify({ configured: false, reason: 'no_config' }));
   }
   " 2>/dev/null || echo '{"configured":false,"reason":"exec_error"}')

   CONFIGURED=$(echo "$NOTION_CHECK" | jq -r '.configured')
   ```

   **If CONFIGURED is "true":**

   Display this banner:
   ```
   ───────────────────────────────────────────────────────────────

   ## Upload Planning Docs to Notion?

   Your milestone planning docs are finalized and ready to share.

   This will sync .planning/ markdown files to Notion:
   - New files create pages
   - Changed files update existing pages
   - Unchanged files are skipped

   ───────────────────────────────────────────────────────────────
   ```

   Then use AskUserQuestion:
   - header: "Notion Sync"
   - question: "Sync planning docs to Notion?"
   - options:
     - "Sync now" -- Run notion-sync.js
     - "Skip" -- Continue to completion message

   **If user selects "Sync now":**

   Run sync as child process with inherited stdio for real-time progress visibility:
   ```bash
   echo ""
   echo "Syncing to Notion..."
   echo ""

   if node bin/notion-sync.js sync --cwd "$(pwd)"; then
     echo ""
     echo "Planning docs synced to Notion"
   else
     echo ""
     echo "Sync encountered errors. You can retry with /gsd:sync-notion"
     echo "Milestone completion will proceed regardless."
   fi
   ```

   IMPORTANT: Use `node bin/notion-sync.js sync --cwd "$(pwd)"` without --parent-page flag. The sync command reads parent_page_id from config.json or notion-sync.json automatically. Do NOT assume parent page is always configured (Phase 12 made it optional).

   IMPORTANT: Sync errors must NOT block milestone completion. Always proceed to the completion message regardless of sync exit code. Notion sync is a best-effort publishing convenience.

   **If user selects "Skip":**

   Display: `Skipped Notion sync. Run /gsd:sync-notion later to upload docs.`

   **If CONFIGURED is "false":**

   Skip silently -- no prompt, no message. Users who don't use Notion should not see irrelevant prompts.

2. **Then display the existing "All Phases Complete" message** (moved from current position to after step 14e):

   ```
   ───────────────────────────────────────────────────────────────

   ## All Phases Complete

   This was the last phase in the current roadmap.

   **Options:**
   - `/gsd:complete-milestone` -- Mark milestone as shipped and archive
   - `/gsd:add-phase` -- Add more phases to current milestone

   ───────────────────────────────────────────────────────────────
   ```

   STOP here.

The `milestone_complete === false` branch (auto-advance) remains unchanged.

Also update the success_criteria section at the bottom of plan-phase.md to add:
- `- [ ] Notion sync prompt shown when milestone complete and Notion configured (step 14e)`
- `- [ ] Notion sync skipped silently when not configured`

**Key pattern reference:** This follows the proven pattern from complete-milestone.md lines 586-642 (prompt_notion_sync step). The pre-check is enhanced with API key prefix validation (secret_ or ntn_) per NOTION-04 requirement.

**What NOT to do:**
- Do NOT add a network call (validateAuth) in the pre-check -- format validation is sufficient, API validation happens inside notion-sync.js
- Do NOT capture sync output then re-display it -- inherit stdio for live streaming progress
- Do NOT pass --parent-page flag explicitly -- let notion-sync.js resolve parent from config
- Do NOT block completion on sync failure -- always show "All Phases Complete" message
  </action>
  <verify>
Read get-shit-done/workflows/plan-phase.md and verify:
1. Step 14e exists between step 14d route-to-next and the completion message
2. Pre-check reads config.json and validates api_key prefix (secret_ or ntn_)
3. AskUserQuestion offers "Sync now" / "Skip" options
4. Sync spawns `node bin/notion-sync.js sync --cwd "$(pwd)"` without --parent-page flag
5. Sync errors are caught but do not prevent completion message display
6. Silent skip when CONFIGURED is false (no prompt, no message)
7. Completion message ("All Phases Complete") appears AFTER sync step, not before
8. Success criteria section includes Notion sync items
9. The milestone_complete === false branch (auto-advance) is unchanged
  </verify>
  <done>
Step 14e exists in plan-phase.md with: pre-check validating api_key prefix, conditional AskUserQuestion prompt, notion-sync.js spawn with error handling, silent skip when not configured, completion message always shown after sync step.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update requirements traceability for PLAN-03 and NOTION-04</name>
  <files>.planning/REQUIREMENTS.md</files>
  <action>
Update .planning/REQUIREMENTS.md to mark PLAN-03 and NOTION-04 as complete:

1. Change `- [ ] **PLAN-03**:` to `- [x] **PLAN-03**:` (line ~20)
2. Change `- [ ] **NOTION-04**:` to `- [x] **NOTION-04**:` (line ~27)
3. In the Traceability table, update PLAN-03 status from "Pending" to "Complete"
4. In the Traceability table, update NOTION-04 status from "Pending" to "Complete"
5. Update the "Last updated" line at the bottom to reflect Phase 14 completion date and description

Do NOT change any other content in the file.
  </action>
  <verify>
Read .planning/REQUIREMENTS.md and verify:
1. PLAN-03 checkbox is checked `[x]`
2. NOTION-04 checkbox is checked `[x]`
3. Both entries in traceability table show "Complete"
4. All other requirements remain unchanged
  </verify>
  <done>
PLAN-03 and NOTION-04 marked as complete in REQUIREMENTS.md with updated traceability table.
  </done>
</task>

</tasks>

<verification>
Phase 14 verification checks:

1. **PLAN-03 coverage:** plan-phase.md step 14d/14e shows sync prompt when milestone_complete === true, before completion message
2. **NOTION-04 coverage:** Pre-check validates API key exists, is non-empty, and has correct prefix (secret_ or ntn_) before showing prompt
3. **Silent skip:** When Notion is not configured, no prompt appears and user proceeds directly to completion
4. **Error resilience:** Sync errors produce warning message but completion message always displays
5. **No parent page assumption:** Sync command uses --cwd only, lets notion-sync.js resolve parent page from config
6. **Live progress:** Sync inherits stdio for real-time file-by-file progress visibility
7. **Pattern consistency:** Follows complete-milestone.md prompt_notion_sync pattern (lines 586-642)
</verification>

<success_criteria>
- plan-phase.md contains step 14e with Notion pre-check + conditional sync prompt
- Pre-check validates API key format (prefix: secret_ or ntn_) without network call
- User sees "Sync planning docs to Notion?" prompt only when Notion is configured
- Sync spawns notion-sync.js as child process with inherited stdio
- Sync errors do not prevent "All Phases Complete" message from displaying
- Silent skip when Notion not configured (no prompt, no message)
- REQUIREMENTS.md shows PLAN-03 and NOTION-04 as complete
</success_criteria>

<output>
After completion, create `.planning/phases/14-notion-sync-integration/14-01-SUMMARY.md`
</output>
