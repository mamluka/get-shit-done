---
phase: 02-git-integration
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - "get-shit-done/bin/gsd-tools.js"
  - "get-shit-done/workflows/complete-milestone.md"
autonomous: true
must_haves:
  truths:
    - "Completing a milestone creates an annotated git tag project-{slug}-v{N} on the current project branch"
    - "Tag creation verifies we are on the correct project/{slug} branch before tagging"
    - "Tag message includes milestone version, name, date, and phase/plan counts"
    - "Tag creation is best-effort: milestone completion succeeds even if tagging fails (returns git_error)"
    - "If not on a project branch, tag creation is skipped with a warning rather than blocking milestone completion"
    - "PM can see project status including current branch, available branches, and tags via the git status subcommand"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "createMilestoneTag function and git status subcommand"
      contains: "createMilestoneTag"
    - path: "get-shit-done/workflows/complete-milestone.md"
      provides: "Updated milestone workflow showing branch and tag info"
      contains: "project-"
  key_links:
    - from: "cmdMilestoneComplete()"
      to: "createMilestoneTag()"
      via: "Called after archiving, before final output"
      pattern: "createMilestoneTag"
    - from: "createMilestoneTag()"
      to: "getCurrentBranch()"
      via: "Verifies correct branch before tagging"
      pattern: "getCurrentBranch"
    - from: "createMilestoneTag()"
      to: "execGit(cwd, ['tag', '-a'"
      via: "Creates annotated tag with message"
      pattern: "tag.*-a"
---

<objective>
Add milestone tagging to the milestone completion flow and provide git project status visibility.

Purpose: This implements GIT-02 (milestone tagging) and completes Success Criteria #2 and #4 from the Phase 2 roadmap. When a PM completes a milestone, an annotated git tag is created on the project branch, providing permanent version markers in git history. The PM can also view their git project status at any time.

Output: gsd-tools.js with createMilestoneTag() integrated into cmdMilestoneComplete(), updated complete-milestone workflow, and git status subcommand.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<constraints>
CRITICAL: The .claude/ folder is the INSTALLED framework (local to each user). It is NOT part of the project codebase and must NEVER be modified, committed, or referenced as a target file. All source code changes go to the ROOT get-shit-done/ folder. The mapping is:
- Source code: get-shit-done/bin/gsd-tools.js (MODIFY THIS)
- Installed copy: .claude/get-shit-done/bin/gsd-tools.js (NEVER TOUCH)
- Source workflows: get-shit-done/workflows/*.md (MODIFY THIS)
- Installed workflows: .claude/get-shit-done/workflows/*.md (NEVER TOUCH)
- Source commands: commands/gsd/*.md (MODIFY THIS)
- Installed commands: .claude/commands/gsd/*.md (NEVER TOUCH)
</constraints>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-git-integration/02-RESEARCH.md
@.planning/phases/02-git-integration/02-01-SUMMARY.md
@get-shit-done/bin/gsd-tools.js
@get-shit-done/workflows/complete-milestone.md
@commands/gsd/complete-milestone.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add createMilestoneTag and integrate into milestone completion</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add the `createMilestoneTag()` function and integrate it into the existing `cmdMilestoneComplete()` function.

**1. Add createMilestoneTag(cwd, projectSlug, version, tagMessage)**

Place this near the other git helpers added in Plan 01 (after createAndSwitchBranch, switchToProjectBranch, etc.).

```javascript
/**
 * Create an annotated git tag for a milestone on the project branch.
 * @param {string} cwd - Working directory
 * @param {string} projectSlug - Sanitized project name (already git-safe)
 * @param {string} version - Milestone version string (e.g., "v1.0")
 * @param {string} tagMessage - Tag annotation message
 * @returns {object} Result with exitCode, tag name, or error
 */
function createMilestoneTag(cwd, projectSlug, version, tagMessage) {
  const safeName = sanitizeForGit(projectSlug);
  const tagName = `project-${safeName}-${version}`;

  // Verify we're on a project branch
  const currentBranch = getCurrentBranch(cwd);
  if (!currentBranch) {
    return { exitCode: 1, error: 'Detached HEAD state. Cannot create tag without being on a branch.' };
  }

  const expectedBranch = `project/${safeName}`;
  if (currentBranch !== expectedBranch) {
    // Warn but don't block -- PM might be on main or another branch
    // This is a soft check: the tag will still be created on whatever branch they're on
    // but we note the mismatch
    return {
      exitCode: 1,
      error: `Not on project branch. Expected ${expectedBranch}, currently on ${currentBranch}. Switch to the project branch first with /gsd:switch-project.`,
      expected_branch: expectedBranch,
      current_branch: currentBranch,
    };
  }

  // Check if tag already exists
  const checkResult = execGit(cwd, ['tag', '-l', tagName]);
  if (checkResult.exitCode === 0 && checkResult.stdout.trim() === tagName) {
    return { exitCode: 1, error: `Tag ${tagName} already exists.`, tag: tagName };
  }

  // Create annotated tag (-a flag) with message (-m flag)
  // Annotated tags store: tagger name, email, date, and message
  const result = execGit(cwd, ['tag', '-a', tagName, '-m', tagMessage]);
  if (result.exitCode !== 0) {
    return { exitCode: result.exitCode, error: `Failed to create tag: ${result.stderr}`, tag: tagName };
  }

  return { exitCode: 0, tag: tagName, created: true, branch: currentBranch };
}
```

**2. Integrate into cmdMilestoneComplete():**

In the existing `cmdMilestoneComplete()` function (around line 3282), add tag creation AFTER the milestone archiving and state updates are complete, but BEFORE the final `output()` call.

Find the section where `const result = {` is being constructed (around line 3380). Before that line, add:

```javascript
// GIT-02: Create annotated tag on project branch
let gitTag = null;
let gitTagError = null;
try {
  // Get project slug from active project or from STATE.md
  const activeProject = getActiveProject(cwd);
  if (activeProject) {
    const tagMsg = `Milestone ${version}: ${milestoneName}\n\nPhases: ${phaseCount}, Plans: ${totalPlans}, Tasks: ${totalTasks}\nDate: ${today}`;
    const tagResult = createMilestoneTag(cwd, activeProject, version, tagMsg);
    if (tagResult.exitCode === 0) {
      gitTag = tagResult.tag;
    } else {
      gitTagError = tagResult.error;
    }
  } else {
    gitTagError = 'No active project. Tag creation skipped.';
  }
} catch (err) {
  gitTagError = `Tag creation failed: ${err.message}`;
}
```

Then add to the `result` object:
```javascript
git_tag: gitTag,           // e.g., "project-my-app-v1.0" or null
git_tag_error: gitTagError, // null if tag was created successfully
```

**IMPORTANT:** Tag creation must be best-effort. The existing milestone completion logic (archiving, state updates, MILESTONES.md) must still succeed even if git tagging fails. The PM should see a warning about the tag failure but the milestone should still be marked complete.

**3. Add `git status` subcommand to the `git` case in the dispatcher:**

Extend the `case 'git':` block added in Plan 01 with a `status` subcommand:

```javascript
} else if (subcommand === 'status') {
  const currentBranch = getCurrentBranch(cwd);
  const isProjectBranch = currentBranch?.startsWith('project/') || false;
  const projectName = isProjectBranch ? currentBranch.replace('project/', '') : null;
  const projectBranches = listProjectBranches(cwd);

  // Get tags for current project branch
  let projectTags = [];
  if (projectName) {
    const tagResult = execGit(cwd, ['tag', '-l', `project-${projectName}-*`]);
    if (tagResult.exitCode === 0 && tagResult.stdout.trim()) {
      projectTags = tagResult.stdout.trim().split('\n').filter(Boolean);
    }
  }

  output({
    current_branch: currentBranch,
    on_project_branch: isProjectBranch,
    current_project: projectName,
    available_projects: projectBranches.map(b => b.replace('project/', '')),
    project_count: projectBranches.length,
    tags: projectTags,
  }, raw);
}
```

This gives PMs a complete picture of their git state.

**4. Wire getActiveProject() for tag creation:**

The `createMilestoneTag` integration in step 2 uses `getActiveProject(cwd)` which was created in Phase 1 Plan 02. If it doesn't exist yet, add a simple version:

```javascript
function getActiveProject(cwd) {
  try {
    const activeProjectPath = path.join(cwd, '.planning', '.active-project');
    if (fs.existsSync(activeProjectPath)) {
      return fs.readFileSync(activeProjectPath, 'utf-8').trim();
    }
    return null;
  } catch {
    return null;
  }
}
```

Only add this if the function doesn't already exist from Phase 1. Check first with `grep`.
  </action>
  <verify>
Verify createMilestoneTag exists:
```bash
grep -n "function createMilestoneTag" get-shit-done/bin/gsd-tools.js
```

Verify it's wired into cmdMilestoneComplete:
```bash
grep -n "createMilestoneTag" get-shit-done/bin/gsd-tools.js
```
Should show 2+ matches (definition + usage).

Verify git status subcommand:
```bash
node ./get-shit-done/bin/gsd-tools.js git status --raw
```
Should return JSON with current_branch, on_project_branch, tags, etc.

Run existing test suite:
```bash
node --test get-shit-done/bin/gsd-tools.test.js
```
  </verify>
  <done>createMilestoneTag() creates annotated git tags with project-{slug}-{version} naming. cmdMilestoneComplete() calls it after archiving (best-effort -- milestone succeeds even if tagging fails). `git status` subcommand shows branch, project, and tag info. Existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Update complete-milestone workflow to show git branch and tag info</name>
  <files>get-shit-done/workflows/complete-milestone.md</files>
  <action>
Update the existing complete-milestone workflow to display git integration information. The workflow at `get-shit-done/workflows/complete-milestone.md` needs two additions:

**1. Add branch verification step:**

In the workflow's pre-flight or verification section, add a check that the PM is on the correct project branch before completing the milestone:

Add after the audit check section:
```markdown
## Branch Check

Before completing the milestone, verify git branch status:

```bash
BRANCH_STATUS=$(node ./get-shit-done/bin/gsd-tools.js git status --raw)
```

Parse the output. If `on_project_branch` is false:
- Display: "Warning: You are not on a project branch (currently on {current_branch}). The milestone tag will not be created. Switch to the project branch with /gsd:switch-project if you want the tag."
- Do NOT block completion -- this is informational only.

If `on_project_branch` is true:
- Display: "On project branch: {current_branch}"
```

**2. Update the tag creation section:**

The existing workflow step 7 ("Commit and tag") creates a generic `v{version}` tag. Update this section to note that the project-specific annotated tag is now created automatically by `cmdMilestoneComplete()`:

Replace or update the tag section with:
```markdown
## Tag (Automatic)

The milestone tag is created automatically during completion:
- Tag name: `project-{slug}-{version}` (e.g., `project-mobile-app-v1.0`)
- Type: Annotated tag with milestone metadata
- Branch: Created on the current project branch

If the tag creation fails (not on project branch, not in git repo, etc.), a warning is shown but the milestone is still marked complete.

No manual `git tag` command is needed.
```

**3. Add tag confirmation to success output:**

In the completion display section, add the tag info:
```markdown
After completion, display:
```
Milestone {version} completed!

  Archived: ROADMAP.md, REQUIREMENTS.md
  Tag: {git_tag} (on branch {current_branch})

  {If git_tag_error:}
  Warning: Tag not created - {git_tag_error}
```
```

Read the existing complete-milestone.md workflow file first to understand its current structure, then make these targeted additions without disrupting the existing flow. The key change is that tagging is now automatic via gsd-tools.js rather than manual via the workflow.
  </action>
  <verify>
Verify the workflow file was updated:
```bash
grep -c "project-" get-shit-done/workflows/complete-milestone.md
```
Should be 1+ (project-specific tag reference).

```bash
grep -c "git status\|Branch Check\|Automatic" get-shit-done/workflows/complete-milestone.md
```
Should be 1+ (new sections added).

Run existing test suite:
```bash
node --test get-shit-done/bin/gsd-tools.test.js
```
  </verify>
  <done>complete-milestone.md workflow includes branch verification check before completion, notes that project-specific annotated tags are created automatically by gsd-tools.js, and displays tag info in the success output. Manual git tag step replaced with automatic tagging via cmdMilestoneComplete(). Existing tests pass.</done>
</task>

</tasks>

<verification>
1. `grep -c "function createMilestoneTag" get-shit-done/bin/gsd-tools.js` returns 1
2. `grep "createMilestoneTag" get-shit-done/bin/gsd-tools.js | wc -l` returns 2+ (definition + usage)
3. `node ./get-shit-done/bin/gsd-tools.js git status --raw` returns valid JSON with branch and tag info
4. `grep "git_tag" get-shit-done/bin/gsd-tools.js | wc -l` returns 2+ (in cmdMilestoneComplete result)
5. `grep "project-" get-shit-done/workflows/complete-milestone.md | wc -l` returns 1+ (tag naming reference)
6. `node --test get-shit-done/bin/gsd-tools.test.js` passes
7. Tag creation is conditional on being on project branch (verified by grep for "expectedBranch")
</verification>

<success_criteria>
- Annotated git tag project-{slug}-{version} created during milestone completion
- Tag includes milestone metadata (version, name, date, stats)
- Tag creation verifies correct project branch before proceeding
- Tag creation is best-effort: milestone completion never blocked by git failures
- Already-existing tags are detected and reported as error (not overwritten)
- PM can check git status via `gsd-tools.js git status` command
- complete-milestone workflow shows branch status and tag confirmation
- Existing test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-git-integration/02-02-SUMMARY.md`
</output>
