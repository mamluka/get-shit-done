---
phase: 06-foundation-sdk-setup
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - bin/notion-sync.js
  - lib/notion/client.js
autonomous: false
user_setup: []

must_haves:
  truths:
    - "notion-sync.js CLI tool exists and runs via `node bin/notion-sync.js <command>`"
    - "CLI reads Notion API key from .planning/config.json notion section without hardcoding"
    - "SDK client initializes with rate limit retry config (respects 3 req/sec via exponential backoff)"
    - "Running `node bin/notion-sync.js auth-check` validates the token against Notion API and reports success or failure"
    - "Missing or invalid API key produces a clear error message pointing to config.json"
  artifacts:
    - path: "bin/notion-sync.js"
      provides: "CLI entry point for all Notion operations"
      contains: "#!/usr/bin/env node"
    - path: "lib/notion/client.js"
      provides: "Notion SDK client initialization with config-based auth and retry settings"
      exports: ["createNotionClient", "validateAuth"]
  key_links:
    - from: "bin/notion-sync.js"
      to: "lib/notion/client.js"
      via: "require for SDK client creation"
      pattern: "require.*lib/notion/client"
    - from: "lib/notion/client.js"
      to: ".planning/config.json"
      via: "reads notion.api_key from config file"
      pattern: "config\\.notion\\.api_key"
    - from: "lib/notion/client.js"
      to: "@notionhq/client"
      via: "SDK Client constructor with retry config"
      pattern: "new Client"
---

<objective>
Create the notion-sync.js CLI tool and Notion SDK client module that authenticates with the Notion API using the key from config.json and provides the foundation for all future Notion operations.

Purpose: This is the executable backbone of v1.1 Notion integration. Every subsequent phase (7-10) will add subcommands to this CLI tool. Without working authentication and SDK initialization, no Notion operations can proceed.

Output: bin/notion-sync.js (CLI entry point), lib/notion/client.js (SDK client module)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-foundation-sdk-setup/06-RESEARCH.md
@.planning/phases/06-foundation-sdk-setup/06-01-SUMMARY.md
@package.json
@lib/notion/sync-state.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Notion SDK client module and CLI tool with auth-check command</name>
  <files>
    lib/notion/client.js
    bin/notion-sync.js
  </files>
  <action>
    **Part A: lib/notion/client.js** — SDK client initialization module

    1. Create `lib/notion/client.js` with these exports:

       **`loadNotionConfig(cwd)`** — Reads `.planning/config.json`, returns the `notion` section. Throws descriptive error if:
       - config.json doesn't exist ("No .planning/config.json found. Run npx get-shit-done-cc to set up.")
       - notion section is missing ("No Notion configuration in config.json. Add notion.api_key to .planning/config.json")
       - api_key is missing or empty ("Notion API key not found. Add notion.api_key to .planning/config.json")

    2. **`createNotionClient(cwd)`** — Reads config via loadNotionConfig, creates and returns a Notion Client instance:
       ```javascript
       const { Client } = require('@notionhq/client');
       return new Client({
         auth: config.notion.api_key,
         // Rate limit protection: SDK handles 429 retries automatically
         // Using higher retry count for batch operations (default is 2)
         retry: {
           maxRetries: 3,
           initialRetryDelayMs: 500,
           maxRetryDelayMs: 60000,
         },
         timeoutMs: 60000,
       });
       ```
       Uses 3 retries (not default 2) because GSD will do batch operations during sync.

    3. **`validateAuth(notion)`** — Takes a Notion Client instance, calls `notion.users.me()` to verify the token is valid. Returns:
       - Success: `{ valid: true, bot_name: "GSD Sync", workspace: "My Workspace" }`
       - Failure: `{ valid: false, error: "descriptive message" }`
       Uses try/catch with `isNotionClientError` for type-safe error handling per SDK docs. Maps common errors:
       - APIErrorCode.Unauthorized → "API key is invalid or expired"
       - Network errors → "Cannot reach Notion API. Check your internet connection."

    4. Use synchronous fs operations for config reading. The Notion SDK calls are async (return Promises), so validateAuth is an async function.

    5. Include JSDoc comments on all exports.

    **Part B: bin/notion-sync.js** — CLI entry point

    1. Create `bin/notion-sync.js` with `#!/usr/bin/env node` shebang.

    2. Implement a simple subcommand router:
       ```
       Usage: node bin/notion-sync.js <command> [options]

       Commands:
         auth-check    Verify Notion API key is valid
         help          Show this help message

       Options:
         --cwd <path>  Working directory (default: process.cwd())
       ```

    3. **`auth-check` subcommand:**
       - Calls createNotionClient(cwd) to get SDK client
       - Calls validateAuth(notion) to test the token
       - On success: prints "Notion authentication successful" with bot name and workspace
       - On failure: prints error message with guidance on how to fix
       - Exit code 0 on success, 1 on failure

    4. **`help` subcommand** (and default when no command given):
       - Prints the usage message above
       - Lists available commands with descriptions
       - Exit code 0

    5. **Error handling:**
       - If loadNotionConfig throws (no config, no key), catch and print the error message + exit 1
       - Unknown subcommand: print "Unknown command: {cmd}" + help text + exit 1

    6. Use `--cwd` flag parsing (simple args parsing, no external library):
       ```javascript
       const args = process.argv.slice(2);
       const cwdIndex = args.indexOf('--cwd');
       const cwd = cwdIndex !== -1 ? args[cwdIndex + 1] : process.cwd();
       const command = args.find(a => !a.startsWith('--') && a !== cwd);
       ```

    7. The CLI is async at the top level (auth-check calls Notion API). Use an async main() with `.catch()`:
       ```javascript
       async function main() { ... }
       main().catch(err => { console.error(err.message); process.exit(1); });
       ```

    8. Output format: Plain text with colors matching existing GSD style (cyan for info, green for success, yellow for warnings, dim for hints). Import color codes at the top:
       ```javascript
       const cyan = '\x1b[36m';
       const green = '\x1b[32m';
       const yellow = '\x1b[33m';
       const red = '\x1b[31m';
       const dim = '\x1b[2m';
       const reset = '\x1b[0m';
       ```
  </action>
  <verify>
    - `node bin/notion-sync.js help` prints usage with auth-check command listed, exit code 0
    - `node bin/notion-sync.js unknown-cmd` prints error + help, exit code 1
    - `node -e "const c = require('./lib/notion/client.js'); console.log(typeof c.createNotionClient, typeof c.validateAuth, typeof c.loadNotionConfig)"` prints "function function function"
    - `node bin/notion-sync.js auth-check --cwd /nonexistent` prints config not found error, exit code 1
    - If a valid Notion API key is in .planning/config.json: `node bin/notion-sync.js auth-check` prints success with bot name
  </verify>
  <done>
    lib/notion/client.js exports createNotionClient (reads config, creates SDK Client with retry config), validateAuth (tests token via users.me), and loadNotionConfig (config.json reader with clear errors). bin/notion-sync.js is a working CLI with auth-check and help subcommands. SDK uses 3 retries with exponential backoff for rate limit protection.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Notion authentication works end-to-end</name>
  <files>none - verification only</files>
  <action>
    Present the verification steps below to the user. This checkpoint validates the complete Phase 6 Notion foundation: npm dependencies, .gitignore security, API key setup, notion-sync.json state management, and notion-sync.js CLI auth-check.

    User needs a Notion integration token from https://www.notion.so/my-integrations before verifying.
  </action>
  <verify>
    1. Ensure you have a Notion integration token (create one at https://www.notion.so/my-integrations if needed)

    2. Add your API key to `.planning/config.json`:
       ```json
       {
         "notion": {
           "api_key": "secret_YOUR_KEY_HERE"
         }
       }
       ```
       (Or it may already be there from the install flow)

    3. Run: `node bin/notion-sync.js auth-check`
       - Expected: Green success message showing bot name and workspace name
       - If error: Check the error message — it should clearly indicate what's wrong

    4. Test with invalid key: temporarily change api_key to "secret_invalid123" and run auth-check again
       - Expected: Red error message saying key is invalid

    5. Test with missing config: `node bin/notion-sync.js auth-check --cwd /tmp`
       - Expected: Error about missing config.json

    6. Verify security: `git status` should NOT show .planning/config.json as modified/staged (it's gitignored)

    Resume signal: Type "approved" if auth-check works correctly, or describe any issues.
  </verify>
  <done>
    Human confirms: auth-check succeeds with valid key, fails gracefully with invalid key, errors clearly with missing config, and config.json is properly gitignored.
  </done>
</task>

</tasks>

<verification>
Phase 6 Plan 02 verification:
1. `node bin/notion-sync.js help` — prints usage without errors
2. `node bin/notion-sync.js auth-check` — validates token against Notion API (requires valid key in config)
3. `node -e "require('./lib/notion/client.js')"` — module loads without error
4. `node bin/notion-sync.js auth-check --cwd /tmp` — graceful error for missing config
5. Human verifies auth-check works with real Notion API key
</verification>

<success_criteria>
- bin/notion-sync.js runs as CLI with subcommand routing (auth-check, help)
- lib/notion/client.js creates authenticated Notion SDK client from config.json
- SDK retry config uses 3 retries with exponential backoff (rate limit protection)
- auth-check validates token by calling Notion API and reports success/failure clearly
- Missing or invalid config produces actionable error messages
- Human confirms real Notion API authentication works
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundation-sdk-setup/06-02-SUMMARY.md`
</output>
