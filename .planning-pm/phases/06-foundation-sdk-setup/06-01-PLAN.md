---
phase: 06-foundation-sdk-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - .gitignore
  - .planning/.gitignore
  - bin/install.js
  - lib/notion/sync-state.js
autonomous: true
user_setup:
  - service: notion
    why: "Notion API integration for syncing planning docs"
    env_vars:
      - name: NOTION_API_KEY
        source: "https://www.notion.so/my-integrations -> Create new integration -> Copy 'Internal Integration Secret'"
    dashboard_config:
      - task: "Create a Notion integration"
        location: "https://www.notion.so/my-integrations -> New integration -> name it 'GSD Sync' -> Submit"
      - task: "Share target workspace page with integration"
        location: "Open target Notion page -> ... menu -> Connections -> Add 'GSD Sync'"

must_haves:
  truths:
    - "npm install succeeds and @notionhq/client + @tryfabric/martian appear in package.json dependencies"
    - ".planning/config.json and .planning/notion-sync.json are git-ignored and will never be committed"
    - "User is prompted for Notion API key during npx install flow and key saves to config.json notion section"
    - "notion-sync.json schema can track workspace page ID, project root pages, and file-to-page-ID mappings"
  artifacts:
    - path: "package.json"
      provides: "Notion SDK dependencies"
      contains: "@notionhq/client"
    - path: ".planning/.gitignore"
      provides: "Git ignore rules for sensitive config"
      contains: "config.json"
    - path: "bin/install.js"
      provides: "Notion API key prompt in setup flow"
      contains: "notion"
    - path: "lib/notion/sync-state.js"
      provides: "notion-sync.json read/write/schema helpers"
      exports: ["loadSyncState", "saveSyncState", "initSyncState"]
  key_links:
    - from: "bin/install.js"
      to: ".planning/config.json"
      via: "readline prompt saves API key to config notion section"
      pattern: "notion.*api_key"
    - from: "lib/notion/sync-state.js"
      to: ".planning/notion-sync.json"
      via: "JSON read/write with schema validation"
      pattern: "notion-sync\\.json"
---

<objective>
Install Notion SDK dependencies, enforce git security for sensitive config files, extend the npx install flow to collect Notion API key, and define the notion-sync.json tracking schema.

Purpose: Establish the dependency, security, and configuration foundation that all subsequent Notion phases build on. Without this, no Notion API calls can be made and tokens risk leaking into git.

Output: package.json with Notion deps, .gitignore rules, install.js Notion prompt, sync-state.js module
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-foundation-sdk-setup/06-RESEARCH.md
@bin/install.js
@package.json
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Notion SDK dependencies and enforce .gitignore security</name>
  <files>
    package.json
    package-lock.json
    .gitignore
    .planning/.gitignore
  </files>
  <action>
    1. Run `npm install @notionhq/client @tryfabric/martian` to add production dependencies.
       - Verify both appear in package.json `dependencies` section (not devDependencies).
       - This is the FIRST external production dependency for GSD — package.json currently has `"dependencies": {}`.

    2. Create `.planning/.gitignore` with these entries:
       ```
       config.json
       notion-sync.json
       ```
       This prevents sensitive API keys in config.json and local state in notion-sync.json from being committed.

    3. Add to root `.gitignore` (append at end):
       ```
       # Notion sync state (per-project, contains API-derived page IDs)
       .planning/config.json
       .planning/notion-sync.json
       ```
       Double-protection: both .planning/.gitignore and root .gitignore guard these files.

    4. Verify git will ignore these files:
       - Run `git check-ignore .planning/config.json` — must output the path
       - Run `git check-ignore .planning/notion-sync.json` — must output the path

    NOTE: config.json already exists and is already tracked by git. The .gitignore addition prevents FUTURE commits of changes. If config.json is already tracked, run `git rm --cached .planning/config.json` to untrack it (file stays on disk, just no longer in git). This is critical for token security.
  </action>
  <verify>
    - `node -e "const p = require('./package.json'); console.log(p.dependencies['@notionhq/client'], p.dependencies['@tryfabric/martian'])"` prints two version strings
    - `cat .planning/.gitignore` shows config.json and notion-sync.json entries
    - `git check-ignore .planning/config.json` returns the path (exit code 0)
    - `git check-ignore .planning/notion-sync.json` returns the path (exit code 0)
  </verify>
  <done>
    @notionhq/client and @tryfabric/martian are in package.json dependencies. Both .planning/config.json and .planning/notion-sync.json are git-ignored at both .planning/.gitignore and root .gitignore levels. If config.json was previously tracked, it is now untracked.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Notion API key prompt to npx install flow</name>
  <files>bin/install.js</files>
  <action>
    Extend `bin/install.js` to prompt for Notion API key during setup. This implements SETUP-01 and SETUP-02.

    1. Find the section in install.js where the interactive setup completes (after runtime/location selection, before the final success message). Add a new optional step that:

       a. Asks: "Would you like to configure Notion integration? (optional) [y/N]"
       b. If yes, prompts: "Enter your Notion API key (from https://www.notion.so/my-integrations):"
       c. Validates the key starts with `secret_` or `ntn_` (Notion internal integration tokens use these prefixes)
       d. If invalid format, warns and asks again (max 2 retries, then skip with message)

    2. When a valid key is provided:
       a. Find or create `.planning/config.json` in the project directory (use the same config path pattern as gsd-tools.js — `path.join(cwd, '.planning', 'config.json')`)
       b. Read existing config if present, merge with new `notion` section:
          ```json
          {
            "notion": {
              "api_key": "secret_XXXXX..."
            }
          }
          ```
       c. Write the merged config back to `.planning/config.json`
       d. Print confirmation: "Notion API key saved to .planning/config.json"

    3. If user declines or skips:
       - Print: "Skipped. You can add your Notion API key later to .planning/config.json"
       - Do NOT create the notion section — other code will handle missing notion config gracefully

    4. Use the existing readline patterns already in install.js (lines 1550+, 1580+, 1627+). Follow the same `rl.question()` and `rl.close()` patterns.

    5. This prompt should be NON-BLOCKING: if .planning/ directory doesn't exist yet (fresh install without a project), skip the prompt entirely with no error. The key can be added later via config.json manual edit or on next `npx get-shit-done-cc` run.

    IMPORTANT: The prompt goes AFTER all file copying/symlinking is complete but BEFORE the final "Installation complete" message. It's an optional enhancement step, not a gate.
  </action>
  <verify>
    - Read `bin/install.js` and confirm:
      - There is a "Notion integration" prompt section
      - It validates `secret_` or `ntn_` prefix
      - It reads/writes `.planning/config.json` with notion.api_key
      - It handles decline gracefully
    - Manually test: `echo "N" | node bin/install.js --claude --local` should skip Notion prompt without error
  </verify>
  <done>
    install.js prompts for optional Notion API key after setup completes. Valid keys (secret_* or ntn_*) are saved to .planning/config.json in a `notion` section. Users can skip without any error or side effect.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create notion-sync.json schema and state management module</name>
  <files>lib/notion/sync-state.js</files>
  <action>
    Create `lib/notion/sync-state.js` — a Node.js module that manages the notion-sync.json file for tracking Notion page IDs per project.

    1. Create the `lib/notion/` directory at the repo root.

    2. Implement sync-state.js with these exports:

       **`initSyncState(cwd)`** — Creates a fresh notion-sync.json at `.planning/notion-sync.json` with the default schema:
       ```json
       {
         "version": 1,
         "workspace_page_id": null,
         "projects": {}
       }
       ```
       Returns the created state object. Does NOT overwrite if file exists.

       **`loadSyncState(cwd)`** — Reads and parses `.planning/notion-sync.json`. Returns the state object. If file doesn't exist, calls initSyncState and returns the new state.

       **`saveSyncState(cwd, state)`** — Writes state to `.planning/notion-sync.json` with JSON.stringify(state, null, 2). Validates the top-level schema before writing (must have `version`, `workspace_page_id`, `projects` keys).

       **`getProjectState(state, projectSlug)`** — Returns the project entry from state.projects[projectSlug], or null if not found.

       **`setProjectState(state, projectSlug, projectState)`** — Sets state.projects[projectSlug] = projectState. Returns the modified state.

       **`getPageId(state, projectSlug, filePath)`** — Looks up a file's Notion page ID from state.projects[projectSlug].doc_pages[filePath]. Returns page ID string or null.

       **`setPageId(state, projectSlug, filePath, pageId)`** — Sets a file-to-page-ID mapping. Creates intermediate objects if needed (projects[slug], doc_pages). Returns modified state.

    3. Project state schema (for each project in `projects`):
       ```json
       {
         "root_page_id": null,
         "phase_pages": {},
         "doc_pages": {}
       }
       ```
       - `root_page_id`: The Notion page ID for the project's root page
       - `phase_pages`: Maps phase slug (e.g., "06-foundation-sdk-setup") to Notion page ID
       - `doc_pages`: Maps relative file path (e.g., ".planning/phases/06-foundation-sdk-setup/06-RESEARCH.md") to Notion page ID

    4. Use only Node.js built-in modules (fs, path). No external dependencies in this module.

    5. All functions use synchronous fs operations (readFileSync, writeFileSync) to match existing codebase patterns (gsd-tools.js is fully synchronous).

    6. Include JSDoc comments on all exported functions with @param and @return types.

    7. Add the `lib` directory to the `files` array in package.json so it's included in npm distribution.
  </action>
  <verify>
    - `node -e "const s = require('./lib/notion/sync-state.js'); console.log(Object.keys(s))"` prints the exported function names
    - `node -e "const s = require('./lib/notion/sync-state.js'); const state = s.initSyncState('/tmp/test-gsd'); console.log(JSON.stringify(state))"` prints valid JSON with version, workspace_page_id, projects
    - `cat package.json | grep -c '"lib"'` returns 1 (lib in files array)
  </verify>
  <done>
    lib/notion/sync-state.js exists with loadSyncState, saveSyncState, initSyncState, getProjectState, setProjectState, getPageId, setPageId exports. All functions are synchronous, use Node.js built-ins only, and manage .planning/notion-sync.json with the defined schema. package.json includes lib in its files distribution list.
  </done>
</task>

</tasks>

<verification>
Phase 6 Plan 01 verification:
1. `npm ls @notionhq/client @tryfabric/martian` — both packages installed
2. `git check-ignore .planning/config.json .planning/notion-sync.json` — both paths ignored
3. `grep -c "notion" bin/install.js` — Notion prompt code exists in installer
4. `node -e "require('./lib/notion/sync-state.js')"` — module loads without error
5. `cat package.json | node -e "const p=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8')); console.log(p.files.includes('lib'), Object.keys(p.dependencies).length >= 2)"` — lib in files, 2+ deps
</verification>

<success_criteria>
- @notionhq/client and @tryfabric/martian in package.json dependencies
- .planning/config.json and .planning/notion-sync.json are git-ignored
- bin/install.js has optional Notion API key prompt
- lib/notion/sync-state.js manages notion-sync.json CRUD with defined schema
- package.json files array includes lib for npm distribution
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundation-sdk-setup/06-01-SUMMARY.md`
</output>
