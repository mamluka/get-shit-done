---
phase: 03-workflow-simplification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/get-shit-done/bin/gsd-tools.js
  - .claude/commands/gsd/complete-phase.md
  - .claude/get-shit-done/workflows/complete-phase.md
autonomous: true

must_haves:
  truths:
    - "PM can run /gsd:complete-phase {N} to mark a phase complete"
    - "Before marking complete, system validates phase has at least one plan"
    - "Before marking complete, system validates all mapped requirements are addressed in plans"
    - "After marking complete, system automatically outputs next-phase guidance"
    - "If current phase is the last phase, system prompts for milestone completion instead of advancing"
    - "Validation warnings allow override â€” PM can force-complete with incomplete plans"
  artifacts:
    - path: ".claude/commands/gsd/complete-phase.md"
      provides: "Slash command entry point for /gsd:complete-phase"
      contains: "complete-phase"
    - path: ".claude/get-shit-done/workflows/complete-phase.md"
      provides: "Workflow orchestrating validation, state update, and auto-advance"
      contains: "auto-advance"
    - path: ".claude/get-shit-done/bin/gsd-tools.js"
      provides: "validatePhaseComplete() function and enhanced cmdPhaseComplete()"
      contains: "validatePhaseComplete"
  key_links:
    - from: ".claude/commands/gsd/complete-phase.md"
      to: ".claude/get-shit-done/workflows/complete-phase.md"
      via: "@reference in execution_context"
      pattern: "workflows/complete-phase"
    - from: ".claude/get-shit-done/workflows/complete-phase.md"
      to: ".claude/get-shit-done/bin/gsd-tools.js"
      via: "node gsd-tools.js phase complete"
      pattern: "phase complete"
    - from: ".claude/get-shit-done/bin/gsd-tools.js"
      to: ".planning/ROADMAP.md"
      via: "validatePhaseComplete reads roadmap for requirement mapping"
      pattern: "validatePhaseComplete"
---

<objective>
Implement auto-advance phase completion with pre-validation and last-phase milestone handling.

Purpose: WKFL-03, WKFL-04, and WKFL-06 require that marking a phase complete automatically advances to planning the next phase, but only after validating completeness (plans exist, requirements mapped). When the last phase completes, the system prompts for milestone completion instead.

Output: New /gsd:complete-phase command + workflow, enhanced gsd-tools.js with validatePhaseComplete() and improved cmdPhaseComplete().
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-workflow-simplification/03-RESEARCH.md
@.claude/get-shit-done/bin/gsd-tools.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validatePhaseComplete() and enhance cmdPhaseComplete() in gsd-tools.js</name>
  <files>.claude/get-shit-done/bin/gsd-tools.js</files>
  <action>
    Read gsd-tools.js fully to understand existing patterns. Then make these changes:

    **1. Add validatePhaseComplete() function** (place near cmdPhaseComplete at ~line 2928):

    ```javascript
    function validatePhaseComplete(cwd, phaseNum) {
      const result = { valid: true, warnings: [], errors: [] };
      const phaseInfo = findPhaseInternal(cwd, phaseNum);

      if (!phaseInfo || !phaseInfo.found) {
        result.valid = false;
        result.errors.push(`Phase ${phaseNum} not found`);
        return result;
      }

      // Check 1: At least one PLAN exists
      if (!phaseInfo.plans || phaseInfo.plans.length === 0) {
        result.warnings.push('No plans created for this phase');
      }

      // Check 2: Requirements mapped (if REQUIREMENTS.md exists)
      const reqPath = path.join(cwd, '.planning', 'REQUIREMENTS.md');
      if (fs.existsSync(reqPath)) {
        const reqContent = fs.readFileSync(reqPath, 'utf-8');

        // Find requirements mapped to this phase in the traceability table
        // Pattern: | REQ-ID | Phase N | Status |
        const phasePattern = new RegExp(
          `\\|\\s*(\\w+-\\d+)\\s*\\|\\s*Phase\\s+${phaseNum}\\s*\\|\\s*(\\w+)\\s*\\|`,
          'gi'
        );
        let match;
        const mappedReqs = [];
        const pendingReqs = [];
        while ((match = phasePattern.exec(reqContent)) !== null) {
          mappedReqs.push(match[1]);
          if (match[2].toLowerCase() === 'pending') {
            pendingReqs.push(match[1]);
          }
        }

        if (pendingReqs.length > 0) {
          result.warnings.push(
            `${pendingReqs.length} requirement(s) still pending: ${pendingReqs.join(', ')}`
          );
        }
      }

      return result;
    }
    ```

    **2. Enhance cmdPhaseComplete()** (modify existing function at ~line 2930):

    Add auto-advance data to the return output. The existing function already:
    - Marks phase complete in ROADMAP.md
    - Finds next phase
    - Updates STATE.md

    After the existing output object (around line 3055), add these fields to the result:
    - `validation`: result of validatePhaseComplete()
    - `auto_advance`: true if nextPhaseNum exists
    - `milestone_complete`: true if isLastPhase

    The enhanced result object should be:
    ```javascript
    const validation = validatePhaseComplete(cwd, phaseNum);

    const result = {
      completed_phase: phaseNum,
      phase_name: phaseInfo.phase_name,
      plans_executed: `${summaryCount}/${planCount}`,
      next_phase: nextPhaseNum,
      next_phase_name: nextPhaseName,
      is_last_phase: isLastPhase,
      date: today,
      roadmap_updated: fs.existsSync(roadmapPath),
      state_updated: fs.existsSync(statePath),
      validation: validation,
      auto_advance: !isLastPhase && nextPhaseNum !== null,
      milestone_complete: isLastPhase,
    };
    ```

    **3. Register the 'validate' subcommand** in the main() switch statement under the 'phase' case (~line 4460). Add a new case:
    ```javascript
    case 'validate':
      return cmdPhaseValidate(cwd, args[2], raw);
    ```

    And add a small cmdPhaseValidate function that just calls validatePhaseComplete and outputs the result:
    ```javascript
    function cmdPhaseValidate(cwd, phaseNum, raw) {
      if (!phaseNum) {
        error('phase number required for phase validate');
      }
      const result = validatePhaseComplete(cwd, phaseNum);
      output(result, raw);
    }
    ```

    **Important:** Keep all operations synchronous to match the existing codebase pattern (Phase 1 decision). Use only fs (synchronous) and path modules. No external dependencies.
  </action>
  <verify>
    Run these commands to verify:
    1. `node .claude/get-shit-done/bin/gsd-tools.js phase validate 1 --raw` should return JSON with `valid`, `warnings`, `errors` fields
    2. `grep -c "validatePhaseComplete" .claude/get-shit-done/bin/gsd-tools.js` should return at least 3 (function def + call in cmdPhaseComplete + call in cmdPhaseValidate)
    3. `grep "auto_advance" .claude/get-shit-done/bin/gsd-tools.js` should show the field in cmdPhaseComplete result
    4. `node .claude/get-shit-done/bin/gsd-tools.js --help 2>&1 | head -20` should not error (basic sanity)
  </verify>
  <done>
    validatePhaseComplete() exists and checks for plans and requirement mapping. cmdPhaseComplete() returns auto_advance and milestone_complete fields. `phase validate` subcommand is registered and functional.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create complete-phase command and workflow</name>
  <files>
    .claude/commands/gsd/complete-phase.md
    .claude/get-shit-done/workflows/complete-phase.md
  </files>
  <action>
    **Create .claude/commands/gsd/complete-phase.md:**

    Follow the existing command pattern (see plan-phase.md, discuss-phase.md as examples). The command should:
    - Name: `gsd:complete-phase`
    - Description: "Mark a phase as complete with validation and auto-advance to next phase"
    - Argument-hint: "{phase-number}"
    - Allowed-tools: Read, Write, Edit, Glob, Grep, Bash, Task
    - Objective: Mark phase complete after validating planning artifacts are sufficient, then auto-advance to planning the next phase (or prompt for milestone completion if this is the last phase)
    - execution_context: reference @./.claude/get-shit-done/workflows/complete-phase.md
    - context: $ARGUMENTS for phase number, @.planning/ROADMAP.md, @.planning/STATE.md
    - process: Execute the complete-phase workflow end-to-end

    **Create .claude/get-shit-done/workflows/complete-phase.md:**

    The workflow should orchestrate these steps:

    Step 1 - Validate: Run `node ./.claude/get-shit-done/bin/gsd-tools.js phase validate {N} --raw` to check completeness. Parse the JSON result.

    Step 2 - Report validation: If warnings exist, present them to the user clearly:
    - "Phase {N} has {count} warning(s):"
    - List each warning
    - Ask: "Continue marking phase complete? (yes/no)"
    - If errors (not warnings), block completion entirely with helpful message.

    Step 3 - Complete phase: Run `node ./.claude/get-shit-done/bin/gsd-tools.js phase complete {N} --raw`. Parse the JSON result.

    Step 4 - Auto-advance or milestone prompt:
    - If `auto_advance` is true: Output "Phase {N} is complete. Auto-advancing to Phase {next}..." then present the user with the next step: "Run `/gsd:plan-phase {next}` to begin planning, or `/gsd:discuss-phase {next}` to scope it first."
    - If `milestone_complete` is true: Output "Phase {N} is complete. This was the last phase in the roadmap." then present: "Run `/gsd:complete-milestone` to finalize this milestone."

    Step 5 - Commit: Run `node ./.claude/get-shit-done/bin/gsd-tools.js commit "docs(phase-{N}): mark phase complete" --files .planning/ROADMAP.md .planning/STATE.md`

    **Key design choices:**
    - Auto-advance does NOT automatically spawn plan-phase (that would be over-engineering per research). It returns structured guidance.
    - Validation warns but does not block by default (per research: "warn but allow override").
    - The workflow reads STATE.md first (required_reading pattern from other workflows).
    - Use the `<step>` XML structure matching other workflow files.
  </action>
  <verify>
    1. File exists: `ls .claude/commands/gsd/complete-phase.md` succeeds
    2. File exists: `ls .claude/get-shit-done/workflows/complete-phase.md` succeeds
    3. Command has required frontmatter: `grep "name: gsd:complete-phase" .claude/commands/gsd/complete-phase.md`
    4. Workflow references gsd-tools: `grep "gsd-tools.js" .claude/get-shit-done/workflows/complete-phase.md` returns matches
    5. Workflow handles auto-advance: `grep "auto_advance\|auto-advance" .claude/get-shit-done/workflows/complete-phase.md` returns matches
    6. Workflow handles milestone: `grep "milestone" .claude/get-shit-done/workflows/complete-phase.md` returns matches
  </verify>
  <done>
    /gsd:complete-phase command and workflow exist. Workflow validates completeness, marks phase complete, and either auto-advances to next phase or prompts for milestone completion. Requirements WKFL-03, WKFL-04, and WKFL-06 are satisfied.
  </done>
</task>

</tasks>

<verification>
- `node .claude/get-shit-done/bin/gsd-tools.js phase validate 1 --raw` returns valid JSON
- `node .claude/get-shit-done/bin/gsd-tools.js phase complete` (no args) returns an error message (not a crash)
- complete-phase command file has proper YAML frontmatter
- complete-phase workflow references all required gsd-tools.js commands
- Auto-advance path exists in workflow (next_phase guidance)
- Milestone-complete path exists in workflow (last phase handling)
- Requirements WKFL-03, WKFL-04, WKFL-06 addressed
</verification>

<success_criteria>
- validatePhaseComplete() function exists in gsd-tools.js and checks plans + requirements
- cmdPhaseComplete() returns auto_advance and milestone_complete fields
- /gsd:complete-phase command exists with proper frontmatter
- complete-phase workflow handles: validation, completion, auto-advance, and last-phase milestone prompt
- All operations are synchronous (matching Phase 1 decision)
</success_criteria>

<output>
After completion, create `.planning/phases/03-workflow-simplification/03-02-SUMMARY.md`
</output>
