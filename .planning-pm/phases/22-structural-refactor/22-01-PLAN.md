---
phase: 22-structural-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/gsd-tools.js
  - lib/jira/sync-state.js
  - lib/jira/issue-creator.js
  - lib/jira/ticket-mapper.js
  - lib/notion/client.js
  - lib/notion/sync-state.js
  - lib/notion/sync-orchestrator.js
  - lib/notion/hierarchy.js
  - bin/install.js
autonomous: true

must_haves:
  truths:
    - "PathResolver resolves all paths under .planning-pm/ instead of .planning/"
    - "gsd-tools init commands report planning_exists based on .planning-pm/ directory"
    - "jira-sync.json is read from and written to .planning-pm/{slug}/v{N}/jira-sync.json (versioned project folder)"
    - "notion-sync.json continues to resolve via resolvePlanningPath under .planning-pm/"
    - "bin/install.js creates and references .planning-pm/ for config operations"
    - "All lib/ modules resolve planning paths under .planning-pm/"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "PathResolver with .planning-pm base path"
      contains: ".planning-pm"
    - path: "lib/jira/sync-state.js"
      provides: "jira-sync.json read/write resolving to versioned project folder"
      exports: ["loadSyncState", "saveSyncState", "diffTickets"]
    - path: "bin/install.js"
      provides: "Installation config pointing to .planning-pm/"
      contains: ".planning-pm"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.js PathResolver"
      to: ".planning-pm/ directory"
      via: "this.planningRoot = path.join(cwd, '.planning-pm')"
      pattern: "planningRoot.*planning-pm"
    - from: "lib/jira/sync-state.js resolvePlanningPath"
      to: ".planning-pm/{slug}/v{N}/jira-sync.json"
      via: "Uses PathResolver-style resolution with version folder"
      pattern: "resolvePlanningPath.*jira-sync"
    - from: "lib/notion/sync-state.js resolvePlanningPath"
      to: ".planning-pm/ directory"
      via: "planningRoot = path.join(cwd, '.planning-pm')"
      pattern: "planningRoot.*planning-pm"
---

<objective>
Rename all `.planning` path references to `.planning-pm` in JavaScript source files (gsd-tools.js, lib/ modules, bin/install.js) and relocate jira-sync.json resolution from project root to versioned project folder.

Purpose: This is the core infrastructure change. PathResolver is the centralized path resolution layer used by all workflows. The lib/ modules (jira, notion) have their own resolvePlanningPath helpers. All must point to `.planning-pm` for the rename to work. The jira-sync.json relocation (SYNC-01, SYNC-02) is done here since it modifies the same sync-state.js file.

Output: All JS files reference `.planning-pm` instead of `.planning`. jira-sync.json resolves to versioned project folder.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/21-update-semantics-tracking/21-01-SUMMARY.md

@get-shit-done/bin/gsd-tools.js
@lib/jira/sync-state.js
@lib/jira/issue-creator.js
@lib/jira/ticket-mapper.js
@lib/notion/client.js
@lib/notion/sync-state.js
@lib/notion/sync-orchestrator.js
@lib/notion/hierarchy.js
@bin/install.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename .planning to .planning-pm in gsd-tools.js</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Replace ALL occurrences of `.planning` with `.planning-pm` in gsd-tools.js. This file has approximately 55 references spread across:

1. **PathResolver class (line ~723):** Change `this.planningRoot = path.join(cwd, '.planning')` to `this.planningRoot = path.join(cwd, '.planning-pm')`.

2. **All hardcoded `.planning/` path strings throughout the file.** These appear in:
   - `path.join(cwd, '.planning')` calls (~10 occurrences outside PathResolver, e.g., in `cmdGetActiveProject`, `cmdListProjects`, `cmdCreateProject`, `migrateToNested`, init commands)
   - String literals like `'.planning/'`, `'.planning/config.json'`, `'.planning/phases/'`, `'.planning/todos/'`, `'.planning/codebase'`, `'.planning/quick'`
   - `isGitIgnored(cwd, '.planning')` call
   - Output/display strings like `"path: path.join('.planning', ...)"` and `".planning/REQUIREMENTS.md"`
   - `@.planning/PROJECT.md`, `@.planning/ROADMAP.md`, `@.planning/STATE.md` context references in init commands

**IMPORTANT:** Use a careful find-and-replace of the string `.planning` with `.planning-pm` but ONLY in contexts where it refers to the directory name. Do NOT replace occurrences inside comments that explain the old behavior or in doc strings where the context is about "planning" as a concept. Specifically:
- Replace `'.planning'` with `'.planning-pm'` (in path.join and string literals)
- Replace `".planning"` with `".planning-pm"` (in any double-quoted strings)
- Replace `.planning/` with `.planning-pm/` (in path references)
- Replace `@.planning/` with `@.planning-pm/` (in context references)
- Do NOT change the JSDoc description text like "Centralized path resolution for .planning/ directory structure" -- update these too since they should reflect the new name
- Do NOT change variable names like `planningRoot` or `planningDir` -- those are internal variable names and don't need renaming

After replacement, verify the file still parses correctly with `node -c get-shit-done/bin/gsd-tools.js`.
  </action>
  <verify>
Run: `node -c get-shit-done/bin/gsd-tools.js` -- must exit 0 (no syntax errors)

Run: `grep -c "\.planning/" get-shit-done/bin/gsd-tools.js` -- should return 0 (no remaining .planning/ references)
Note: grep for `.planning/` specifically. There may be `.planning-pm/` references which is correct.

Run: `grep -c "\.planning-pm" get-shit-done/bin/gsd-tools.js` -- should be approximately 55 (same count as previous .planning references)

Run: `node -e 'var PathResolver = require("./get-shit-done/bin/gsd-tools.js"); console.log("OK")'` -- may not work if gsd-tools.js doesn't export PathResolver, but at minimum `node -c` must pass
  </verify>
  <done>
All `.planning` references in gsd-tools.js are replaced with `.planning-pm`. PathResolver.planningRoot points to `.planning-pm`. All path.join calls, string literals, context references, and display strings use `.planning-pm`. File parses without syntax errors. Zero remaining `.planning/` references (excluding `.planning-pm/`).
  </done>
</task>

<task type="auto">
  <name>Task 2: Rename .planning to .planning-pm in lib/ modules and bin/install.js, relocate jira-sync.json to project folder</name>
  <files>
lib/jira/sync-state.js
lib/jira/issue-creator.js
lib/jira/ticket-mapper.js
lib/notion/client.js
lib/notion/sync-state.js
lib/notion/sync-orchestrator.js
lib/notion/hierarchy.js
bin/install.js
  </files>
  <action>
**Part A: Rename `.planning` to `.planning-pm` in all lib/ modules and bin/install.js**

For each of these files, replace ALL occurrences of `.planning` (as directory reference) with `.planning-pm`:

1. **lib/jira/sync-state.js** (~3 occurrences): `path.join(cwd, '.planning')` and comment references
2. **lib/jira/issue-creator.js** (~3 occurrences): `resolvePlanningPath` helper, `path.join(cwd, '.planning')`
3. **lib/jira/ticket-mapper.js** (~6 occurrences): Two `resolvePlanningPath` helpers, `path.join(cwd, '.planning')`, `.planning/ROADMAP.md` and `.planning/REQUIREMENTS.md` string lookups
4. **lib/notion/client.js** (~5 occurrences): `path.join(cwd, '.planning', 'config.json')` and error messages referencing `.planning/config.json`
5. **lib/notion/sync-state.js** (~3 occurrences): `path.join(cwd, '.planning')` and comment references
6. **lib/notion/sync-orchestrator.js** (~4 occurrences): `path.join(cwd, '.planning')` and comment references
7. **lib/notion/hierarchy.js** (~2 occurrences): Comment references to `.planning/` directory
8. **bin/install.js** (~7 occurrences): `path.join(process.cwd(), '.planning')` and console.log messages referencing `.planning/config.json`

For ticket-mapper.js, also update the Notion link lookup keys from `.planning/ROADMAP.md` and `.planning/REQUIREMENTS.md` to `.planning-pm/ROADMAP.md` and `.planning-pm/REQUIREMENTS.md`.

**Part B: Relocate jira-sync.json to versioned project folder (SYNC-01, SYNC-02)**

In `lib/jira/sync-state.js`, modify the `resolvePlanningPath` function so that `jira-sync.json` resolves to the versioned project folder instead of the project root:

Current behavior: `.planning/{slug}/jira-sync.json` (at project root level)
New behavior: `.planning-pm/{slug}/v{N}/jira-sync.json` (inside versioned folder)

To implement this, change `resolvePlanningPath` to also read the current version from STATE.md (similar to how PathResolver reads `current_version`):

```javascript
function resolvePlanningPath(cwd, filename) {
  const planningRoot = path.join(cwd, '.planning-pm');
  const activeProjectPath = path.join(planningRoot, '.active-project');

  try {
    if (fs.existsSync(activeProjectPath)) {
      const slug = fs.readFileSync(activeProjectPath, 'utf8').trim();
      if (slug) {
        // Try to resolve version from STATE.md
        const statePath = path.join(planningRoot, 'STATE.md');
        let version = null;
        if (fs.existsSync(statePath)) {
          const stateContent = fs.readFileSync(statePath, 'utf8');
          const versionMatch = stateContent.match(/current_version:\s*(.+)/);
          if (versionMatch) {
            version = versionMatch[1].trim();
          }
        }

        if (version) {
          // Versioned project folder: .planning-pm/{slug}/{version}/
          const versionedDir = path.join(planningRoot, slug, version);
          if (fs.existsSync(versionedDir)) {
            return path.join(versionedDir, filename);
          }
        }

        // Fall back to project root: .planning-pm/{slug}/
        const nested = path.join(planningRoot, slug);
        if (fs.existsSync(nested)) {
          return path.join(nested, filename);
        }
      }
    }
  } catch (e) {
    // Fall through to default
  }

  return path.join(planningRoot, filename);
}
```

Apply this same updated `resolvePlanningPath` to `lib/jira/issue-creator.js` and `lib/jira/ticket-mapper.js` as well (they have their own copies of the helper). Also apply it to `lib/notion/sync-state.js` and `lib/notion/sync-orchestrator.js` for consistency, though notion-sync.json will continue to live at the project root level since that's where it was designed to be.

IMPORTANT: For the Notion modules, keep the existing behavior (project root, not versioned folder) since notion-sync.json tracks page IDs across all versions. Only jira-sync.json moves into the versioned folder because it's milestone-specific. To achieve this, add versioned resolution ONLY in the jira modules' `resolvePlanningPath`, not in the notion modules' version. For the notion modules, just rename `.planning` to `.planning-pm` without changing the resolution logic.

After all changes, verify each file parses: `node -c <file>`.
  </action>
  <verify>
Run syntax checks on all modified files:
```
node -c lib/jira/sync-state.js
node -c lib/jira/issue-creator.js
node -c lib/jira/ticket-mapper.js
node -c lib/notion/client.js
node -c lib/notion/sync-state.js
node -c lib/notion/sync-orchestrator.js
node -c lib/notion/hierarchy.js
node -c bin/install.js
```
All must exit 0.

Run: `grep -r "path.join.*'\.planning'" lib/ bin/install.js` -- should return 0 matches (all changed to .planning-pm)

Run: `grep -c "\.planning-pm" lib/jira/sync-state.js` -- should be >= 3

Run: `node -e 'var ss = require("./lib/jira/sync-state.js"); console.log(Object.keys(ss));'` -- should output loadSyncState, saveSyncState, diffTickets

Run: `node -e 'var ss = require("./lib/jira/sync-state.js"); console.log(ss.loadSyncState(process.cwd()));'` -- should return null (no .planning-pm/jira-sync.json exists)
  </verify>
  <done>
All 8 files have `.planning` renamed to `.planning-pm`. All files parse without syntax errors. jira-sync.json in sync-state.js resolves to versioned project folder (.planning-pm/{slug}/v{N}/jira-sync.json) for Jira modules. Notion modules resolve to project root (.planning-pm/{slug}/notion-sync.json) unchanged. SYNC-01 and SYNC-02 requirements satisfied.
  </done>
</task>

</tasks>

<verification>
Plan 01 is complete when:
1. gsd-tools.js has zero `.planning/` references (all are `.planning-pm/`)
2. All lib/ modules reference `.planning-pm/` instead of `.planning/`
3. bin/install.js references `.planning-pm/` instead of `.planning/`
4. jira-sync.json resolution in sync-state.js points to versioned project folder
5. All 9 JS files parse without syntax errors
6. FOLD-01, SYNC-01, SYNC-02 requirements are addressed
</verification>

<success_criteria>
- FOLD-01: PathResolver and gsd-tools use `.planning-pm` as the planning folder name
- SYNC-01: jira-sync.json resolves to `.planning-pm/{slug}/v{N}/jira-sync.json`
- SYNC-02: All jira-sync.json references in sync-state module resolve to project folder path
</success_criteria>

<output>
After completion, create `.planning/phases/22-structural-refactor/22-01-SUMMARY.md`
</output>
