---
phase: 22-structural-refactor
plan: 03
type: execute
wave: 2
depends_on: ["22-01", "22-02"]
files_modified:
  - get-shit-done/bin/gsd-tools.js
  - get-shit-done/workflows/new-project.md
autonomous: false

must_haves:
  truths:
    - "Running the migration command renames .planning/ to .planning-pm/ without data loss"
    - "Migration creates a backup before renaming"
    - "Migration is idempotent -- running on already-migrated directory is a no-op"
    - "All gsd-tools init commands work after migration (planning_exists: true)"
    - "All existing workflows continue to function with the new folder structure"
    - "Tests pass with .planning-pm paths"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "migratePlanningFolder function and CLI subcommand"
      contains: "migratePlanningFolder"
    - path: "get-shit-done/workflows/new-project.md"
      provides: "Migration prompt in new-project workflow"
      contains: "migratePlanningFolder"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.js migratePlanningFolder"
      to: ".planning/ directory â†’ .planning-pm/ directory"
      via: "fs.renameSync with backup"
      pattern: "migratePlanningFolder.*renameSync"
    - from: "get-shit-done/bin/gsd-tools.js project migrate-folder"
      to: "migratePlanningFolder function"
      via: "CLI subcommand routing"
      pattern: "migrate-folder.*migratePlanningFolder"
---

<objective>
Add a migration function to safely rename existing `.planning/` directories to `.planning-pm/`, and verify the entire rename works end-to-end with tests passing.

Purpose: Existing projects have a `.planning/` folder. FOLD-05 requires safe migration to `.planning-pm/` with no data loss. This plan adds the migration capability and validates the complete rename via human verification and test execution.

Output: Migration function in gsd-tools.js, CLI subcommand `project migrate-folder`, and verified end-to-end functionality
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-structural-refactor/22-01-SUMMARY.md
@.planning/phases/22-structural-refactor/22-02-SUMMARY.md

@get-shit-done/bin/gsd-tools.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add migratePlanningFolder function and CLI subcommand to gsd-tools.js</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add a `migratePlanningFolder(cwd)` function to gsd-tools.js that safely renames `.planning/` to `.planning-pm/`. Follow the existing `migrateToNested` pattern for style and error handling.

**migratePlanningFolder(cwd):**

```javascript
function migratePlanningFolder(cwd) {
  const oldDir = path.join(cwd, '.planning');
  const newDir = path.join(cwd, '.planning-pm');

  // Already migrated?
  if (fs.existsSync(newDir)) {
    if (fs.existsSync(oldDir)) {
      return { error: 'Both .planning/ and .planning-pm/ exist. Please resolve manually.' };
    }
    return { already_migrated: true, message: '.planning-pm/ already exists. No migration needed.' };
  }

  // Nothing to migrate?
  if (!fs.existsSync(oldDir)) {
    return { error: 'No .planning/ directory found. Nothing to migrate.' };
  }

  // Create backup
  const backupDir = path.join(cwd, '.planning-backup-' + new Date().toISOString().replace(/[:.]/g, '-'));
  try {
    // Copy .planning to backup (use fs.cpSync if available, else shell out)
    if (fs.cpSync) {
      fs.cpSync(oldDir, backupDir, { recursive: true });
    } else {
      const { execSync } = require('child_process');
      execSync(`cp -r "${oldDir}" "${backupDir}"`, { cwd });
    }
  } catch (e) {
    return { error: `Failed to create backup: ${e.message}` };
  }

  // Rename .planning to .planning-pm
  try {
    fs.renameSync(oldDir, newDir);
  } catch (e) {
    return { error: `Failed to rename .planning to .planning-pm: ${e.message}` };
  }

  // Verify migration
  if (!fs.existsSync(newDir)) {
    return { error: 'Migration failed: .planning-pm/ does not exist after rename.' };
  }

  // Clean up backup on success
  try {
    fs.rmSync(backupDir, { recursive: true, force: true });
  } catch (e) {
    // Backup cleanup failure is not critical
  }

  return {
    success: true,
    old_path: '.planning/',
    new_path: '.planning-pm/',
    message: 'Successfully migrated .planning/ to .planning-pm/'
  };
}
```

**Register the CLI subcommand** in the main switch/case block under the `project` command group, alongside the existing `migrate` and `verify-migration` subcommands:

```javascript
} else if (subcommand === 'migrate-folder') {
  const result = migratePlanningFolder(cwd);
  output(result, raw);
}
```

**Also update the new-project workflow** (`get-shit-done/workflows/new-project.md`) to include a migration step. At the beginning of the workflow, before any `.planning-pm/` operations, add a check:

```markdown
**Step 0 (migration check):** Check if `.planning/` exists (old name). If so, run migration:
```bash
MIGRATE=$(node ./.claude/get-shit-done/bin/gsd-tools.js project migrate-folder)
```
If migration succeeds, inform user: "Migrated .planning/ to .planning-pm/ for compatibility."
If already migrated, continue silently.
If error (both exist), stop and ask user to resolve.
```

This ensures existing projects get migrated on first use of any GSD command.
  </action>
  <verify>
Run: `node -c get-shit-done/bin/gsd-tools.js` -- must exit 0

Run: `node ./.claude/get-shit-done/bin/gsd-tools.js project migrate-folder 2>&1` -- should attempt migration (may succeed or report error depending on current directory state)

Run: `grep "migratePlanningFolder" get-shit-done/bin/gsd-tools.js | wc -l` -- should be >= 2 (function definition + CLI routing)

Run: `grep "migrate-folder" get-shit-done/workflows/new-project.md | wc -l` -- should be >= 1
  </verify>
  <done>
migratePlanningFolder function added to gsd-tools.js with backup creation, safe rename, and idempotency handling. CLI subcommand `project migrate-folder` registered. new-project workflow includes migration check step. Function follows existing migrateToNested patterns.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify end-to-end rename and migration</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Human verification of the complete .planning to .planning-pm rename across the entire codebase (JS code, markdown files, tests) plus migration command for existing directories. Jira-sync.json now resolves to versioned project folder.

Steps to verify:

1. **Run the migration on this repo's own .planning/ folder:**
   ```bash
   node ./.claude/get-shit-done/bin/gsd-tools.js project migrate-folder
   ```
   Verify: `.planning-pm/` directory exists with all files intact. `.planning/` no longer exists.

2. **Run the test suite:**
   ```bash
   node --test get-shit-done/bin/gsd-tools.test.js
   ```
   Verify: All tests pass with `.planning-pm` paths.

3. **Run a gsd-tools init command to verify path resolution:**
   ```bash
   node ./.claude/get-shit-done/bin/gsd-tools.js init plan-phase 22
   ```
   Verify: `planning_exists: true` in output, `phase_dir` contains `.planning-pm`.

4. **Verify no stale .planning references remain in code:**
   ```bash
   grep -r "\.planning/" get-shit-done/ commands/ agents/ lib/ bin/ --include="*.js" --include="*.md" | grep -v "\.planning-pm" | grep -v node_modules | grep -v ".planning/phases" | head -20
   ```
   Verify: No output (all references are .planning-pm).

5. **Verify jira-sync.json path resolution:**
   ```bash
   node -e 'var ss = require("./lib/jira/sync-state.js"); console.log(ss.loadSyncState(process.cwd()));'
   ```
   Verify: Returns null or existing state (no errors about missing directory).
  </action>
  <verify>
User confirms all 5 verification steps pass. Type "approved" or describe issues.
  </verify>
  <done>
User confirms: migration renames .planning to .planning-pm without data loss. Tests pass. Init commands work. No stale references remain. jira-sync.json resolves correctly. All FOLD and SYNC requirements satisfied.
  </done>
</task>

</tasks>

<verification>
Plan 03 is complete when:
1. migratePlanningFolder function exists in gsd-tools.js
2. `project migrate-folder` CLI subcommand works
3. Migration successfully renames `.planning/` to `.planning-pm/`
4. Tests pass with `.planning-pm` paths
5. gsd-tools init commands report `planning_exists: true` for `.planning-pm/`
6. No stale `.planning/` references remain in codebase (excluding `.planning-pm/`)
7. FOLD-05 requirement satisfied (safe migration)
</verification>

<success_criteria>
- FOLD-05: Existing `.planning/` folder is migrated to `.planning-pm/` with safe rename
- All existing workflows continue to function with new folder structure
- Tests validate the new paths
</success_criteria>

<output>
After completion, create `.planning/phases/22-structural-refactor/22-03-SUMMARY.md`
Note: After migration, this will be at `.planning-pm/phases/22-structural-refactor/22-03-SUMMARY.md`
</output>
