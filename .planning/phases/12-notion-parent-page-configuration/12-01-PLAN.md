---
phase: 12-notion-parent-page-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/install.js
autonomous: true

must_haves:
  truths:
    - "User is prompted for Notion parent page URL during install (after API key prompt)"
    - "Page ID is extracted from various Notion URL formats (slug-id, bare id, shared links with query params)"
    - "Extracted page ID is validated as 32-char hex and saved to config.json as notion.parent_page_id"
    - "User sees example URL format in prompt and helpful error messages for invalid URLs"
    - "User can skip parent page configuration by pressing Enter (optional field)"
  artifacts:
    - path: "bin/install.js"
      provides: "extractPageIdFromUrl, validatePageId, promptNotionParentPage functions"
      contains: "extractPageIdFromUrl"
  key_links:
    - from: "promptNotionParentPage"
      to: "config.json notion.parent_page_id"
      via: "fs.writeFileSync after validation"
      pattern: "config\\.notion\\.parent_page_id"
    - from: "finishInstall"
      to: "promptNotionParentPage"
      via: "callback chain after promptNotionKey"
      pattern: "promptNotionParentPage"
---

<objective>
Add Notion parent page URL prompt to install.js so users can configure where Notion pages are created during installation.

Purpose: Users currently must manually edit config.json to set parent_page_id. This adds an interactive prompt (chained after the existing API key prompt) that accepts a Notion page URL, extracts the 32-char page ID, validates it, and saves it to config.json. Reduces setup friction for Notion integration.

Output: Modified bin/install.js with extractPageIdFromUrl(), validatePageId(), and promptNotionParentPage() functions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-notion-parent-page-configuration/12-RESEARCH.md
@bin/install.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add extractPageIdFromUrl and validatePageId utility functions</name>
  <files>bin/install.js</files>
  <action>
Add two utility functions to bin/install.js, placed after the existing helper functions (after the `verifyFileInstalled` function around line 1117, before the `install` function at line 1269):

**extractPageIdFromUrl(url):**
- Takes a string URL input
- Returns null if input is falsy or not a string
- Strips query parameters by splitting on '?', takes first segment
- Strips trailing slashes
- Matches 32-character hex string at end of path using case-insensitive regex: `/([a-f0-9]{32})$/i`
- Returns the matched hex string (lowercased), or null if no match
- Handles these URL formats:
  - `https://notion.so/{slug}-{id}` (most common)
  - `https://www.notion.so/{workspace}/{slug}-{id}` (with workspace)
  - `https://notion.so/{id}` (bare ID)
  - `https://notion.so/{slug}-{id}?pvs=4&share=xyz` (shared links with query params)

**validatePageId(pageId):**
- Takes a string page ID input (output from extractPageIdFromUrl)
- Returns `{ valid: false, error: 'No page ID found in URL' }` if input is falsy
- Tests against 32-char hex pattern: `/^[a-f0-9]{32}$/i`
- Also accepts UUID format with dashes: `/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i`
- On match: normalizes to lowercase, removes dashes, returns `{ valid: true, pageId: normalized }`
- On no match: returns `{ valid: false, error: 'Page ID must be 32 hex characters' }`
  </action>
  <verify>
Run from project root:
```bash
node -e "
const m = require('./bin/install.js'); // Won't work directly since install.js runs on require
"
```

Since install.js auto-executes, verify by reading the file and checking the functions exist:
```bash
grep -n 'function extractPageIdFromUrl' bin/install.js
grep -n 'function validatePageId' bin/install.js
```

Both should return line numbers. Also verify the regex patterns are correct:
```bash
grep -c '[a-f0-9]{32}' bin/install.js
```
Should return at least 2 (one in each function).
  </verify>
  <done>
extractPageIdFromUrl and validatePageId functions exist in bin/install.js with correct regex patterns for Notion URL parsing and page ID validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add promptNotionParentPage function and chain into finishInstall</name>
  <files>bin/install.js</files>
  <action>
**Add promptNotionParentPage(callback) function** after the existing `promptNotionKey` function (after line 1577):

1. **TTY check:** If `!process.stdin.isTTY`, call `callback()` immediately and return (non-interactive skip).

2. **Config check:** Read `.planning/config.json`. If `config.notion.api_key` does not exist, skip silently (call `callback()` — no point configuring parent page without API key).

3. **Create readline interface** (same pattern as promptNotionKey, lines 1503-1506).

4. **Display header:**
   ```
   \n  {cyan}Notion Parent Page (optional){reset}\n
     If you want synced pages created under a specific parent page,
     provide its URL below.\n
   ```

5. **askForUrl(retriesLeft) recursive prompt:**
   - Prompt text: `  Parent page URL (or Enter to skip): `
   - If input is empty (user pressed Enter): close readline, print `  Skipped. You can add parent_page_id later to .planning/config.json\n`, call `callback()`, return.
   - Call `extractPageIdFromUrl(trimmed)` then `validatePageId(result)`
   - If validation fails and retriesLeft > 0: print error message with yellow warning, print example URL in dim text (`Example: https://notion.so/My-Page-abc123def456...`), print hint that URL should contain 32-char page ID, call `askForUrl(retriesLeft - 1)`
   - If validation fails and retriesLeft === 0: print `Too many invalid attempts. Skipping.\n`, close readline, call `callback()`
   - If validation passes: close readline, read config.json fresh (handle missing file), ensure `config.notion` object exists (do NOT overwrite — use `if (!config.notion) config.notion = {}`), set `config.notion.parent_page_id = validation.pageId`, write config back with `JSON.stringify(config, null, 2) + '\n'`, print `{green}✓{reset} Parent page ID saved to .planning/config.json\n`, call `callback()`

6. **Invoke:** `askForUrl(2)` — allow 2 retries (same as API key prompt).

**Modify finishInstall function** (around line 1607-1614):

Change the callback chain from:
```javascript
promptNotionKey(() => {
  console.log(`
  ${green}Done!${reset} Launch ${program} ...
```

To:
```javascript
promptNotionKey(() => {
  promptNotionParentPage(() => {
    console.log(`
    ${green}Done!${reset} Launch ${program} ...
```

This chains the parent page prompt after the API key prompt. The parent page function internally checks if API key exists, so:
- User declines Notion integration → API key not saved → parent page prompt skipped silently
- User configures API key → parent page prompt appears → user can configure or skip with Enter
- User already had API key from previous install → promptNotionKey shows "Would you like to configure?" → if No, parent page still checks config and prompts if API key exists from prior install

**Important:** Make sure to add the closing `);` for `promptNotionParentPage` callback, maintaining correct nesting.
  </action>
  <verify>
1. Verify function exists:
```bash
grep -n 'function promptNotionParentPage' bin/install.js
```

2. Verify callback chain in finishInstall:
```bash
grep -A2 'promptNotionKey' bin/install.js | grep 'promptNotionParentPage'
```

3. Verify the file has no syntax errors:
```bash
node -c bin/install.js
```
Should output "bin/install.js: ok" with no errors.

4. Verify config merging pattern (does not overwrite existing notion section):
```bash
grep -A3 'config.notion.parent_page_id' bin/install.js
```
Should show the parent_page_id assignment without overwriting the whole notion object.
  </verify>
  <done>
promptNotionParentPage function exists in bin/install.js with readline prompt, URL extraction, validation, retry logic, skip support, and config.json merge. finishInstall chains promptNotionParentPage after promptNotionKey. File passes syntax check (`node -c`).
  </done>
</task>

</tasks>

<verification>
1. `node -c bin/install.js` passes with no syntax errors
2. `grep -c 'extractPageIdFromUrl\|validatePageId\|promptNotionParentPage' bin/install.js` returns 3+ matches
3. The callback chain in finishInstall shows: promptNotionKey → promptNotionParentPage → completion message
4. Config write uses merge pattern (reads existing, adds parent_page_id to notion section, writes back)
5. Parent page prompt only appears when notion.api_key exists in config.json
6. Empty input (Enter) skips parent page configuration
7. Invalid URLs show example format and allow 2 retries
</verification>

<success_criteria>
- install.js contains extractPageIdFromUrl, validatePageId, and promptNotionParentPage functions
- Parent page prompt appears after API key prompt during install (only when Notion API key is configured)
- Valid Notion URLs have their 32-char hex page ID extracted, validated, and saved as notion.parent_page_id in config.json
- Invalid URLs show helpful error messages with example URL format
- User can skip by pressing Enter (optional field)
- Existing config.json fields (including notion.api_key) are preserved when saving parent_page_id
- File has no syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-notion-parent-page-configuration/12-01-SUMMARY.md`
</output>
