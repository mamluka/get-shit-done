---
phase: 13-auto-discuss-before-planning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/workflows/plan-phase.md
  - commands/gsd/plan-phase.md
autonomous: true

must_haves:
  truths:
    - "When plan-phase runs and CONTEXT.md is missing, user is asked 'Discuss this phase first or plan directly?'"
    - "If user chooses discuss, full interactive discussion runs before planning proceeds"
    - "CONTEXT.md is created and saved before planning steps (research, plan, check) receive it"
    - "Planning steps receive CONTEXT.md content via reloaded init JSON after discussion"
    - "User can skip discussion and plan directly if context is already clear"
    - "--skip-discussion flag bypasses the discussion gate entirely without prompting"
  artifacts:
    - path: "get-shit-done/workflows/plan-phase.md"
      provides: "Step 3b discussion gate with AskUserQuestion, Task() spawn of discuss-phase, init reload pattern"
      contains: "Offer Discussion"
    - path: "commands/gsd/plan-phase.md"
      provides: "Updated argument-hint and flag documentation including --skip-discussion"
      contains: "--skip-discussion"
  key_links:
    - from: "get-shit-done/workflows/plan-phase.md"
      to: "get-shit-done/workflows/discuss-phase.md"
      via: "Task() spawn with discuss-phase workflow reference"
      pattern: "discuss-phase"
    - from: "get-shit-done/workflows/plan-phase.md"
      to: "gsd-tools.js init plan-phase --include context"
      via: "Init reload after discuss-phase creates CONTEXT.md"
      pattern: "init plan-phase.*--include.*context"
---

<objective>
Add a discussion gate to plan-phase workflow that automatically offers to run discuss-phase when CONTEXT.md is missing for the current phase.

Purpose: Ensure context is gathered before formal planning begins, improving plan quality by capturing user decisions and preferences before researcher and planner agents run. This makes discuss-phase a first-class step in the auto-advance loop rather than a separate manual command.

Output: Updated plan-phase.md workflow with step 3b (discussion gate) and updated plan-phase command with --skip-discussion flag.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-auto-discuss-before-planning/13-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add discussion gate step 3b to plan-phase workflow and update command metadata</name>
  <files>
    get-shit-done/workflows/plan-phase.md
    commands/gsd/plan-phase.md
  </files>
  <action>
**In `get-shit-done/workflows/plan-phase.md`:**

1. In step 2 (Parse and Normalize Arguments), add `--skip-discussion` to the extracted flags list. The line currently reads:
   `Extract from $ARGUMENTS: phase number (integer or decimal like `2.1`), flags (`--research`, `--skip-research`, `--gaps`, `--skip-verify`).`
   Add `--skip-discussion` to this list.

2. Insert a new step **3b** between step 4 ("Load CONTEXT.md") and step 4b ("Mark Phase In Progress"). This is the discussion gate. The step should contain:

   **Step heading:** `## 3b. Offer Discussion (if CONTEXT.md missing)`

   **Skip conditions (check first, skip entire step if any are true):**
   - `has_context` is true (CONTEXT.md already exists — from init JSON)
   - `--skip-discussion` flag was passed
   - `--gaps` flag was passed (gap closure mode skips discussion)

   **If none of the skip conditions are met (CONTEXT.md is missing):**

   Display this banner:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    GSD ► PHASE {X} CONTEXT
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   No context file found for Phase {X}: {Name}.

   Discussion helps clarify:
   • UI/UX decisions you care about
   • Behavior preferences
   • Areas where you want control vs Claude's discretion

   This is OPTIONAL — skip if you're ready to plan directly.
   ```

   Then use AskUserQuestion:
   - header: "Phase {X} Context"
   - question: "Discuss phase context before planning?"
   - options:
     - "Discuss context" — Run interactive discussion to capture decisions
     - "Plan directly" — Skip to planning (Claude uses best judgment)

   **If "Discuss context":**

   Spawn the discuss-phase workflow via Task():

   ```
   Task(
     prompt="First, read ~/.claude/get-shit-done/workflows/discuss-phase.md for your role and instructions.\n\n<context>\nPhase number: {phase_number}\n\nLoad project state:\n@.planning/STATE.md\n\nLoad roadmap:\n@.planning/ROADMAP.md\n</context>",
     subagent_type="general-purpose",
     model="{planner_model}",
     description="Discuss Phase {phase} context"
   )
   ```

   After Task() returns, **reload init** to pick up the newly-created CONTEXT.md:

   ```bash
   INIT=$(node ~/.claude/get-shit-done/bin/gsd-tools.js init plan-phase "${PHASE}" --include state,roadmap,requirements,context,research,verification,uat,planning-status)
   ```

   Extract the updated `context_content` from the reloaded INIT JSON. This is critical — the original init from step 1 will have `context_content: null` because CONTEXT.md didn't exist yet. The reload ensures all downstream agents (researcher, planner, checker) receive the discussion output.

   If `has_context` is still false after reload, log a warning: `"Warning: CONTEXT.md not created during discussion — proceeding without context"`

   Display: `Using phase context from: ${PHASE_DIR}/*-CONTEXT.md`

   **If "Plan directly":**

   Proceed to step 4b without any context content. No warning needed — this is a valid user choice.

3. In the success_criteria section at the bottom, add a new item:
   `- [ ] Discussion offered when CONTEXT.md missing (step 3b)`

**In `commands/gsd/plan-phase.md`:**

1. Update the `argument-hint` in frontmatter from:
   `"[phase] [--research] [--skip-research] [--gaps] [--skip-verify]"`
   to:
   `"[phase] [--research] [--skip-research] [--gaps] [--skip-verify] [--skip-discussion]"`

2. In the `<context>` section, add `--skip-discussion` to the flags list:
   ```
   - `--skip-discussion` — Skip discussion gate, plan directly without prompting
   ```
  </action>
  <verify>
    1. Read `get-shit-done/workflows/plan-phase.md` and confirm step 3b exists between step 4 and step 4b with: AskUserQuestion gate, Task() spawn of discuss-phase, init reload after discussion, skip conditions (has_context, --skip-discussion, --gaps)
    2. Read `commands/gsd/plan-phase.md` and confirm `--skip-discussion` appears in argument-hint and flags documentation
    3. Confirm the step uses the established patterns: AskUserQuestion for binary gate (matches complete-milestone.md pattern), Task() spawn (matches researcher spawn in step 5), init reload (matches new-project.md pattern)
  </verify>
  <done>
    - Step 3b exists in plan-phase.md workflow between step 4 and step 4b
    - Step 3b checks has_context, --skip-discussion, and --gaps before prompting
    - AskUserQuestion offers "Discuss context" / "Plan directly" binary choice
    - "Discuss context" spawns discuss-phase via Task() with phase number and model
    - Init is reloaded after discuss-phase completes to pick up context_content
    - "Plan directly" skips to step 4b without warning
    - --skip-discussion flag is documented in command metadata argument-hint
    - Success criteria updated to include discussion gate check
  </done>
</task>

</tasks>

<verification>
1. Step numbering is consistent: 1, 2, 3, 4, 3b, 4b, 5, 6, 7, 8... (3b is correctly positioned between 4 and 4b as specified in research)
2. All five success criteria from the phase are addressed:
   - SC1: AskUserQuestion gate when CONTEXT.md missing (step 3b)
   - SC2: Task() spawns full discuss-phase workflow (step 3b "Discuss context" path)
   - SC3: CONTEXT.md created by discuss-phase, verified via init reload (step 3b post-Task() reload)
   - SC4: Reloaded context_content passed to researcher/planner/checker (init reload updates INIT variable used by steps 5, 7, 8, 10)
   - SC5: "Plan directly" option skips discussion (step 3b "Plan directly" path) and --skip-discussion flag bypasses gate entirely
3. No anti-patterns: no double-prompting, no forced discussion, has_context checked before prompting
4. Requirements coverage: PLAN-01 (auto-advance loop runs discuss-phase when CONTEXT.md missing) and PLAN-02 (discuss-phase runs full interactive flow — already satisfied by existing workflow, spawned via Task())
</verification>

<success_criteria>
- plan-phase workflow has step 3b that gates on has_context === false
- Step 3b uses AskUserQuestion with "Discuss context" / "Plan directly" options
- "Discuss context" spawns discuss-phase via Task() and reloads init after completion
- --skip-discussion flag documented in command metadata and checked in step 3b
- All five phase success criteria are provably addressed
</success_criteria>

<output>
After completion, create `.planning/phases/13-auto-discuss-before-planning/13-01-SUMMARY.md`
</output>
