---
phase: 09-image-handling
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/notion/image-uploader.js
  - test/image-uploader.test.js
autonomous: true

must_haves:
  truths:
    - "Local image paths in markdown are correctly extracted and distinguished from external URLs"
    - "Relative image paths resolve correctly relative to the markdown file's directory"
    - "Files are hashed with SHA-256 for content-addressable deduplication"
    - "Previously uploaded images (matching hash) reuse existing file_upload_id without re-uploading"
    - "Unsupported image formats are rejected with a warning before upload"
    - "Missing local files produce a warning and a fallback paragraph instead of failing the sync"
    - "Files exceeding 20 MB are rejected with a warning"
  artifacts:
    - path: "lib/notion/image-uploader.js"
      provides: "Image extraction, path resolution, hash dedup, File Upload API integration, block post-processing"
      exports: ["extractLocalImages", "resolveImagePath", "processLocalImages", "injectImageBlocks"]
    - path: "test/image-uploader.test.js"
      provides: "TDD tests for image uploader module"
      contains: "describe.*image-uploader"
  key_links:
    - from: "lib/notion/image-uploader.js"
      to: "lib/notion/sync-state.js"
      via: "image_uploads field in notion-sync.json"
      pattern: "image_uploads\\["
    - from: "lib/notion/image-uploader.js"
      to: "@notionhq/client"
      via: "File Upload API (files.createUpload)"
      pattern: "notion\\.files"
---

<objective>
Build the image uploader module with TDD: extract local image references from markdown, resolve relative paths, deduplicate via SHA-256 hashing, upload via Notion File Upload API, and inject image blocks into converted output.

Purpose: Core business logic for IMG-02 (local file upload) and IMG-03 (deduplication tracking). External URLs (IMG-01) already work via Martian with no changes.

Output: Fully tested `lib/notion/image-uploader.js` module ready for Plan 02 integration into converter pipeline.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/09-image-handling/09-RESEARCH.md
@.planning/phases/07-markdown-to-notion-conversion/07-03-SUMMARY.md
@.planning/phases/08-page-hierarchy-incremental-sync/08-01-SUMMARY.md

@lib/notion/sync-state.js
@lib/notion/change-detector.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED - Write failing tests for image uploader module</name>
  <files>test/image-uploader.test.js</files>
  <action>
Create test file `test/image-uploader.test.js` using Node.js built-in test runner (`node:test` + `node:assert`), matching Phase 7 TDD pattern.

Test suites:

**1. extractLocalImages(markdown, markdownFilePath)**
- Extracts `![alt](./images/diagram.png)` as local image with correct alt text and relative path
- Extracts `![](../shared/logo.png)` (no alt text, parent-relative path)
- Extracts `![photo](images/photo.jpg)` (no ./ prefix)
- Does NOT extract `![external](https://example.com/image.png)` (external URL)
- Does NOT extract `![external](http://example.com/image.png)` (http URL)
- Returns empty array for markdown with no images
- Handles multiple images in same markdown, returns all in order
- Handles image inside link `[![alt](path)](url)` — extracts the image path correctly

**2. resolveImagePath(markdownFilePath, imagePathInMarkdown)**
- Resolves `./images/arch.png` from `/project/.planning/ROADMAP.md` to `/project/.planning/images/arch.png`
- Resolves `../diagrams/flow.png` from `/project/.planning/phases/08-sync/08-PLAN.md` to `/project/.planning/phases/diagrams/flow.png`
- Resolves `logo.png` (no prefix) from `/project/.planning/PROJECT.md` to `/project/.planning/logo.png`

**3. validateImageFile(absolutePath)**
- Returns `{ valid: true }` for existing .png file (create a temp file in test setup)
- Returns `{ valid: false, reason: 'not_found' }` for non-existent path
- Returns `{ valid: false, reason: 'unsupported_format' }` for `.pdf`, `.docx`, `.mp4`
- Returns `{ valid: false, reason: 'too_large' }` for file > 20 MB (mock with fs.statSync)
- Accepts all Notion-supported formats: `.bmp`, `.gif`, `.heic`, `.jpeg`, `.jpg`, `.png`, `.svg`, `.tif`, `.tiff`

**4. injectImageBlocks(blocks, imageUploadMap)**
- Replaces paragraph containing `[[IMAGE_UPLOAD:upload-id-1:alt text]]` with image block `{ type: 'image', image: { type: 'file_upload', file_upload: { id: 'upload-id-1' } } }`
- Preserves blocks that don't contain markers
- Handles multiple markers in different paragraphs
- Handles marker with empty alt text: `[[IMAGE_UPLOAD:upload-id-2:]]`

All tests must FAIL when run (no implementation exists yet).

Run: `node --test test/image-uploader.test.js` — verify all tests fail.
Commit: `test(09-01): add failing tests for image uploader module`
  </action>
  <verify>Run `node --test test/image-uploader.test.js` and confirm all tests fail with "Cannot find module" or assertion errors. Zero passes expected.</verify>
  <done>Test file exists with comprehensive test suites covering extraction, path resolution, validation, and block injection. All tests fail (RED phase).</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement image uploader module to pass all tests</name>
  <files>lib/notion/image-uploader.js, test/image-uploader.test.js</files>
  <action>
Create `lib/notion/image-uploader.js` with the following functions:

**extractLocalImages(markdown, markdownFilePath)**
- Regex: `/!\[([^\]]*)\]\((?!https?:\/\/)([^)]+)\)/g` to find local image references
- For each match, resolve path via `resolveImagePath`
- Return array of `{ original, altText, relativePath, absolutePath }`

**resolveImagePath(markdownFilePath, imagePathInMarkdown)**
- Use `path.resolve(path.dirname(markdownFilePath), imagePathInMarkdown)`

**validateImageFile(absolutePath)**
- Check `fs.existsSync(absolutePath)` — if missing, return `{ valid: false, reason: 'not_found' }`
- Check extension against allowlist: `.bmp`, `.gif`, `.heic`, `.jpeg`, `.jpg`, `.png`, `.svg`, `.tif`, `.tiff`
- Check `fs.statSync(absolutePath).size` against 20 MB limit (20 * 1024 * 1024)
- Return `{ valid: true }` if all checks pass

**processLocalImages(markdown, markdownFilePath, notion, syncState, projectSlug, options)**
- Extract local images from markdown
- For each image:
  1. Validate file (skip with warning if invalid)
  2. Hash file content using SHA-256 streaming (reuse pattern from `change-detector.js`)
  3. Check `syncState.projects[projectSlug].image_uploads[hash]` for existing upload
  4. If found, reuse `file_upload_id`
  5. If not found, upload via Notion File Upload API:
     - `notion.files.createUpload({ filename, content_type })` (use `mime-types` package for content_type detection, fallback to 'application/octet-stream')
     - Read file as Buffer, send to upload URL via fetch with FormData
     - Store in `syncState.projects[projectSlug].image_uploads[hash]` = `{ file_upload_id, local_path, uploaded_at, size_bytes, mime_type }`
  6. Replace original markdown image syntax with marker: `[[IMAGE_UPLOAD:${uploadId}:${altText}]]`
- If `options.dryRun` is true, skip upload but still extract and report what would be uploaded
- Return `{ processedMarkdown, uploads: [...], warnings: [...] }`
- Note: `processLocalImages` does NOT need to be tested with real Notion API — test only the pure functions. Integration testing happens in Plan 02.

**injectImageBlocks(blocks, imageUploadMap)**
- Walk blocks array (flatMap)
- For paragraph blocks, check if `rich_text[0]?.text?.content` contains `[[IMAGE_UPLOAD:` pattern
- If match found, replace entire paragraph block with: `{ type: 'image', image: { type: 'file_upload', file_upload: { id: uploadId } } }`
- If paragraph has marker mixed with other text, extract marker and create separate image block + remaining text paragraph
- Return new blocks array

Also install `mime-types` dependency:
```bash
npm install mime-types
```

Run tests: `node --test test/image-uploader.test.js` — all tests should pass.
Commit: `feat(09-01): implement image uploader module`
  </action>
  <verify>Run `node --test test/image-uploader.test.js` and confirm all tests pass. Also run `node -e "require('./lib/notion/image-uploader.js')"` to verify module loads without error.</verify>
  <done>All tests pass (GREEN phase). Module exports extractLocalImages, resolveImagePath, validateImageFile, processLocalImages, injectImageBlocks. mime-types dependency installed.</done>
</task>

</tasks>

<verification>
1. `node --test test/image-uploader.test.js` — all tests pass
2. `node -e "const m = require('./lib/notion/image-uploader.js'); console.log(Object.keys(m))"` — shows all exported functions
3. `node -e "const m = require('./lib/notion/image-uploader.js'); console.log(m.extractLocalImages('![test](./img.png)', '/foo/bar.md'))"` — returns extraction result
4. `node -e "const m = require('./lib/notion/image-uploader.js'); console.log(m.resolveImagePath('/a/b/c.md', './img/x.png'))"` — returns `/a/b/img/x.png`
5. `grep mime-types package.json` — dependency present
</verification>

<success_criteria>
- Image uploader module exists with clean exports for Plan 02 integration
- All pure functions tested via TDD (RED then GREEN)
- SHA-256 hashing reuses Phase 8 streaming pattern
- Path resolution handles all relative forms (./,  ../, bare)
- Validation catches: missing files, unsupported formats, 20MB+ files
- Block injection replaces markers with proper Notion image block schema
- mime-types dependency installed
</success_criteria>

<output>
After completion, create `.planning/phases/09-image-handling/09-01-SUMMARY.md`
</output>
