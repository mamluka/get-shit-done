---
phase: 16-phase-integration-user-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/workflows/notion-comments.md
autonomous: true

must_haves:
  truths:
    - "After comment interpretation, Claude analyzes ROADMAP.md and recommends whether each comment should update an existing phase or create a new phase"
    - "For existing phase updates, Claude identifies which specific phase and what changes are needed (add requirement, update goal, add success criterion)"
    - "For new phase proposals, Claude provides phase name, goal, requirements, and success criteria in ROADMAP.md format"
    - "User is prompted with exactly two choices: 'Discuss changes' or 'Let Claude decide'"
    - "In 'Discuss changes' mode, Claude walks through each proposed change for user approval/modification before applying"
    - "In 'Let Claude decide' mode, Claude auto-incorporates all accepted changes into ROADMAP.md, REQUIREMENTS.md, and relevant phase artifacts"
  artifacts:
    - path: "get-shit-done/workflows/notion-comments.md"
      provides: "Complete notion-comments workflow with phase integration and user control"
      contains: "analyze_and_recommend"
  key_links:
    - from: "interpret_comments step"
      to: "analyze_and_recommend step"
      via: "sequential workflow flow — comments interpreted, then analyzed against ROADMAP.md"
      pattern: "step name=\"analyze_and_recommend\""
    - from: "analyze_and_recommend step"
      to: "incorporate_changes step"
      via: "user chooses discuss vs auto-incorporate, then changes are applied"
      pattern: "step name=\"incorporate_changes\""
---

<objective>
Replace the old cluster_themes, triage_discussion, and save_results steps in the notion-comments workflow with a new phase-integration and user-control flow. After Phase 15's interpret_comments step presents comment understanding, Claude now analyzes the current roadmap, recommends specific phase changes (update existing or create new), and lets the user choose between interactive discussion or auto-incorporation.

Purpose: Transform notion-comments from a passive triage tool into an active planning driver that modifies ROADMAP.md, REQUIREMENTS.md, and phase plans based on comment feedback.
Output: Updated get-shit-done/workflows/notion-comments.md with new workflow steps replacing steps 3-5.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@get-shit-done/workflows/notion-comments.md
@.planning/phases/15-comment-understanding-output/15-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace cluster_themes, triage_discussion, and save_results with analyze_and_recommend and incorporate_changes steps</name>
  <files>get-shit-done/workflows/notion-comments.md</files>
  <action>
Replace the existing steps 3-5 (cluster_themes, triage_discussion, save_results) in the notion-comments workflow with two new steps. Keep fetch_comments and interpret_comments exactly as they are.

**Step 3: analyze_and_recommend** (replaces cluster_themes + triage_discussion opening)

This step runs after interpret_comments. Claude does the following:

1. **Read the current roadmap:** Read `.planning/ROADMAP.md` and `.planning/REQUIREMENTS.md` to understand the current phase structure, goals, requirements, and what's in progress vs complete.

2. **For each interpreted comment**, analyze whether it:
   - **Updates an existing phase** — the feedback relates to a phase that already exists (even if complete). Claude identifies which specific phase and what changes are needed:
     - Add a new requirement
     - Add a new success criterion
     - Update the goal
     - Modify existing requirements
   - **Creates a new phase** — the feedback suggests entirely new capability not covered by any existing phase. Claude proposes:
     - Phase name
     - Goal (outcome-shaped, not task-shaped)
     - Requirements (using the project's requirement ID format from REQUIREMENTS.md)
     - Success criteria (what must be TRUE)
     - Where it fits in the roadmap (which milestone, after which phase)

3. **Present recommendations** in a structured format:

```
## Recommended Changes

Based on the comments, I recommend the following planning changes:

### Change 1: Update Phase {N} — {Phase Name}
**Type:** Update existing phase
**Affected phase:** Phase {N} ({name})
**What to change:**
- Add requirement {ID}: {description}
- Add success criterion: {criterion text}
**Rationale:** {Why this comment maps to this phase}

### Change 2: Create New Phase — {Proposed Name}
**Type:** New phase
**Proposed name:** {name}
**Goal:** {outcome-shaped goal}
**Requirements:**
- {ID}: {description}
**Success criteria:**
1. {criterion}
**Suggested placement:** After Phase {N} in milestone {X}
**Rationale:** {Why this needs a new phase}

### Change 3: ...
```

If no comments warrant planning changes (e.g., all are "nice work" or already addressed), say so and end the workflow:
```
None of the comments require planning changes. All feedback is either already addressed or informational.
```

4. After presenting recommendations, prompt the user with exactly two options:

```
How would you like to proceed?

1. **Discuss changes** — I'll walk through each proposed change for your approval
2. **Let Claude decide** — I'll incorporate all recommended changes automatically

Your choice? (discuss / auto)
```

AskUserQuestion and wait for response.

**Step 4: incorporate_changes** (replaces save_results)

This step handles both paths:

**Path A: "Discuss changes" (CTRL-02)**

For each recommended change, present it individually and ask:

```
## Change {N}/{Total}: {Change title}

{Full change details from recommendations}

**Options:**
- **Accept** — Apply this change as proposed
- **Modify** — Apply with modifications (describe what to change)
- **Skip** — Don't apply this change

Your decision? (accept / modify / skip)
```

AskUserQuestion for each change. If "modify", ask for specifics and update the change accordingly.

After all changes are reviewed, present a summary of accepted changes before applying.

**Path B: "Let Claude decide" (CTRL-03)**

Apply all recommended changes automatically without per-change review.

**Applying changes (both paths converge here):**

For each accepted change, Claude modifies the actual planning artifacts:

1. **For existing phase updates:**
   - Read the target section of `.planning/ROADMAP.md`
   - Add new requirements to the phase's **Requirements** line
   - Add new success criteria to the phase's **Success Criteria** section
   - Update the phase goal if recommended
   - If requirements are added, also add them to `.planning/REQUIREMENTS.md`:
     - Add new requirement entries under the appropriate section (create a new section if needed)
     - Add entries to the Traceability table at the bottom

2. **For new phase creation:**
   - Add a new phase entry to `.planning/ROADMAP.md` following the existing format:
     ```
     ### Phase {N}: {Name}

     **Goal**: {goal}

     **Depends on**: {dependency}

     **Requirements**: {comma-separated IDs}

     **Success Criteria** (what must be TRUE):
       1. {criterion}

     **Plans**: 0 plans (not started)

     Plans:
     - [ ] {N}-01-PLAN.md — TBD
     ```
   - Add new requirements to `.planning/REQUIREMENTS.md`
   - Add to the Progress table in ROADMAP.md
   - Create the phase directory: `.planning/phases/{N}-{slug}/`

3. **Commit all changes:**
   ```bash
   node ~/.claude/get-shit-done/bin/gsd-tools.js commit "docs(16): incorporate comment feedback into planning artifacts" --files .planning/ROADMAP.md .planning/REQUIREMENTS.md
   ```

4. **Present result:**
   ```
   ## Changes Applied

   | Change | Type | Artifact Modified |
   |--------|------|-------------------|
   | {title} | Update Phase {N} | ROADMAP.md, REQUIREMENTS.md |
   | {title} | New Phase {N} | ROADMAP.md, REQUIREMENTS.md |

   Planning artifacts updated. Run `/gsd:plan-phase` to plan any new phases.
   ```

   If no changes were accepted (all skipped in discuss mode):
   ```
   No changes applied. All recommendations were skipped.
   ```

Also update the `<purpose>` tag at the top of the workflow to reflect the new functionality:

Replace:
```
Retrieve unresolved comments from synced Notion pages, identify themes across all feedback, map themes to affected roadmap phases, and walk the user through an interactive triage discussion. Saves results as a dated markdown file for historical reference.
```

With:
```
Retrieve unresolved comments from synced Notion pages, interpret each comment, analyze them against the current roadmap, recommend planning changes (update existing phases or create new ones), and let the user choose between interactive discussion or auto-incorporation. Applies accepted changes directly to ROADMAP.md, REQUIREMENTS.md, and phase directories.
```

Also update the `<success_criteria>` section at the bottom of the workflow to match the new flow:

Replace the existing success criteria with:
```
<success_criteria>
- [ ] Comments fetched from all synced Notion pages
- [ ] Comments interpreted with plain-language understanding
- [ ] Each comment analyzed against current ROADMAP.md and mapped to existing phase update or new phase creation
- [ ] User prompted with "Discuss changes" or "Let Claude decide" choice
- [ ] If discussing: each change individually reviewed with accept/modify/skip
- [ ] If auto: all recommended changes applied automatically
- [ ] Accepted changes applied to ROADMAP.md (phase updates or new phases)
- [ ] New requirements added to REQUIREMENTS.md with traceability
- [ ] Changes committed to git
</success_criteria>
```
  </action>
  <verify>
Read get-shit-done/workflows/notion-comments.md and verify:
1. Steps are: fetch_comments, interpret_comments, analyze_and_recommend, incorporate_changes (exactly 4 steps)
2. The cluster_themes, triage_discussion, and save_results steps are completely removed
3. analyze_and_recommend step includes: roadmap reading, per-comment analysis (update vs new phase), structured recommendation format, discuss/auto prompt
4. incorporate_changes step includes: both discuss and auto paths, artifact modification instructions (ROADMAP.md, REQUIREMENTS.md), git commit, result presentation
5. purpose tag updated to reflect new functionality
6. success_criteria section updated to match new flow
7. fetch_comments and interpret_comments steps are unchanged from Phase 15
  </verify>
  <done>
The notion-comments workflow has exactly 4 steps (fetch_comments, interpret_comments, analyze_and_recommend, incorporate_changes). After comment interpretation, Claude recommends phase changes. User chooses discuss or auto-incorporate. Accepted changes modify ROADMAP.md and REQUIREMENTS.md directly. Old cluster/triage/save steps are gone.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update required_reading and validate workflow integrity</name>
  <files>get-shit-done/workflows/notion-comments.md</files>
  <action>
After the main workflow rewrite, verify and update supporting sections:

1. **required_reading section** — Add `.planning/REQUIREMENTS.md` since the workflow now reads and modifies it:
   ```xml
   <required_reading>
   1. `.planning/ROADMAP.md`
   2. `.planning/STATE.md`
   3. `.planning/REQUIREMENTS.md`
   </required_reading>
   ```

2. **Validate the full workflow** by reading the entire file start to finish:
   - Confirm the `<process>` tag has exactly 4 `<step>` elements
   - Confirm no references to "themes", "triage", "severity", or "dated triage file" remain (these are artifacts of the old flow)
   - Confirm the workflow still references the `notion-sync.js comments` command for fetching
   - Confirm `interpret_comments` is completely untouched from Phase 15
   - Confirm no broken cross-references between steps (e.g., "continue to next step" flows correctly)
   - Confirm AskUserQuestion is used for the discuss/auto prompt and for per-change review

3. **Clean up any orphaned references** in the workflow:
   - Remove any mention of "2-5 themes" or "theme grouping"
   - Remove any mention of "accept/defer/dismiss" triage options
   - Remove any mention of "dated markdown file for historical reference" in context of triage
   - Ensure the interpret_comments step note about "separate from the triage results saved by the save_results step" is updated or removed since save_results no longer exists

Specifically, in the interpret_comments step, find and update or remove this line:
```
**Note:** This interpretation output is separate from the triage results saved by the `save_results` step later in the workflow. The interpretation file provides raw understanding; the triage file records user decisions.
```

Replace with:
```
**Note:** This interpretation output (when saved to file) provides raw understanding of comments. The `incorporate_changes` step later in the workflow applies accepted changes directly to planning artifacts.
```
  </action>
  <verify>
Read get-shit-done/workflows/notion-comments.md and verify:
1. required_reading includes REQUIREMENTS.md
2. No references to "themes", "triage", "severity", "accept/defer/dismiss" remain
3. interpret_comments step note updated to reference incorporate_changes instead of save_results
4. Exactly 4 step elements in the process tag
5. All AskUserQuestion prompts are correctly placed
  </verify>
  <done>
The workflow has consistent internal references, required_reading includes all needed files, no orphaned references to old triage flow remain, and the interpret_comments note correctly references the new incorporate_changes step.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full workflow by reading get-shit-done/workflows/notion-comments.md end-to-end:

1. **Structure check:** Exactly 4 steps in order: fetch_comments, interpret_comments, analyze_and_recommend, incorporate_changes
2. **PINT-01:** analyze_and_recommend reads ROADMAP.md and recommends update-existing vs create-new for each comment
3. **PINT-02:** For existing phase updates, identifies specific phase + what changes are needed
4. **PINT-03:** For new phase creation, proposes name, goal, requirements, success criteria in roadmap format
5. **CTRL-01:** User prompted with "Discuss changes" or "Let Claude decide"
6. **CTRL-02:** Discuss path walks through each change for accept/modify/skip
7. **CTRL-03:** Auto path incorporates all recommended changes automatically
8. **Artifact modification:** Both paths converge on modifying ROADMAP.md and REQUIREMENTS.md
9. **No orphaned references:** No mentions of themes, triage, severity, dated triage file
10. **Backward compatibility:** fetch_comments and interpret_comments unchanged
</verification>

<success_criteria>
- notion-comments workflow has 4 steps (fetch, interpret, analyze_and_recommend, incorporate_changes)
- All 6 requirements (PINT-01/02/03, CTRL-01/02/03) are implemented in the workflow instructions
- Planning artifacts (ROADMAP.md, REQUIREMENTS.md) are modified by the workflow, not just saved to a triage file
- User has clear control over which changes are applied
- Old triage flow (cluster/triage/save) is completely removed
</success_criteria>

<output>
After completion, create `.planning/phases/16-phase-integration-user-control/16-01-SUMMARY.md`
</output>
