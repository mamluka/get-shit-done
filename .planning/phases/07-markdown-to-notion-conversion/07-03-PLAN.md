---
phase: 07-markdown-to-notion-conversion
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - lib/notion/converter.js
  - bin/notion-sync.js
autonomous: true

must_haves:
  truths:
    - "User can convert .planning/ markdown files to Notion block arrays via converter module"
    - "Conversion pipeline chains preprocess -> markdownToBlocks -> splitRichText -> flattenDeepNesting -> convertQuotesToToggles -> chunkBlocks"
    - "Dry-run mode (--dry-run flag) shows what would be converted without making API calls"
    - "File-level progress output shows 'Converting ROADMAP.md (3/8)...' during batch processing"
    - "Lossy element warnings written to .planning/notion-sync.log in JSON Lines format (console stays clean)"
    - "notion-sync.json updated after each file conversion for resume-on-error"
    - "Converter works as importable module for Phase 8 sync integration"
  artifacts:
    - path: "lib/notion/converter.js"
      provides: "Main conversion orchestrator module"
      exports: ["convertMarkdown", "convertFile", "convertDirectory"]
    - path: "bin/notion-sync.js"
      provides: "CLI with convert subcommand"
      contains: "convert"
  key_links:
    - from: "lib/notion/converter.js"
      to: "lib/notion/preprocessor.js"
      via: "preprocessMarkdown() called first in pipeline"
      pattern: "require.*preprocessor"
    - from: "lib/notion/converter.js"
      to: "@tryfabric/martian"
      via: "markdownToBlocks() for core conversion"
      pattern: "require.*martian"
    - from: "lib/notion/converter.js"
      to: "lib/notion/text-splitter.js"
      via: "splitRichText() for 2000-char limit"
      pattern: "require.*text-splitter"
    - from: "lib/notion/converter.js"
      to: "lib/notion/block-utils.js"
      via: "flattenDeepNesting() + convertQuotesToToggles()"
      pattern: "require.*block-utils"
    - from: "lib/notion/converter.js"
      to: "lib/notion/chunker.js"
      via: "chunkBlocks() for API-sized batches"
      pattern: "require.*chunker"
    - from: "lib/notion/converter.js"
      to: "lib/notion/sync-state.js"
      via: "Incremental state updates after each file"
      pattern: "require.*sync-state"
    - from: "bin/notion-sync.js"
      to: "lib/notion/converter.js"
      via: "CLI routes convert command to converter module"
      pattern: "require.*converter"
---

<objective>
Create the converter orchestrator module and wire it into the CLI tool.

Purpose: This plan brings together all utility modules from Plans 01 and 02 into a single conversion pipeline. The converter.js module chains preprocessing, Martian conversion, text splitting, nesting flattening, toggle conversion, and chunking into a cohesive flow. It adds conversion logging, dry-run mode, progress output, and incremental state tracking. The CLI gets a `convert` subcommand for direct user invocation. Critically, the converter is designed as an importable module that Phase 8 (sync) will call — not just a standalone script.

Output: Working converter module and CLI convert command that can transform .planning/ markdown files into chunked Notion block arrays.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-markdown-to-notion-conversion/07-RESEARCH.md
@.planning/phases/07-markdown-to-notion-conversion/07-CONTEXT.md
@.planning/phases/07-markdown-to-notion-conversion/07-01-SUMMARY.md
@.planning/phases/07-markdown-to-notion-conversion/07-02-SUMMARY.md
@lib/notion/preprocessor.js
@lib/notion/text-splitter.js
@lib/notion/block-utils.js
@lib/notion/chunker.js
@lib/notion/sync-state.js
@lib/notion/client.js
@bin/notion-sync.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create converter.js — main conversion orchestrator with logging and state tracking</name>
  <files>lib/notion/converter.js</files>
  <action>
    Create lib/notion/converter.js as the main conversion orchestrator module. This module is the heart of Phase 7 — it chains all utility modules into a complete pipeline and manages conversion state.

    **Exports:**

    **`convertMarkdown(markdown, options = {})`**
    Pure function. Takes raw markdown string, returns `{ blocks: Block[][], warnings: string[] }`.
    Pipeline:
    1. `preprocessMarkdown(markdown)` — transform custom tags, details/summary, unsupported HTML
    2. `markdownToBlocks(preprocessed, martianOptions)` — core Martian conversion
    3. Walk all blocks: for each block with rich_text, run `splitRichText(block[type].rich_text)` to enforce 2000-char limit. When splitting causes a block to produce multiple blocks (paragraph with long text becomes multiple paragraphs), expand inline.
    4. `flattenDeepNesting(blocks)` — flatten 3+ levels to 2 with └ markers
    5. `convertQuotesToToggles(blocks)` — convert details/summary blockquotes to toggles
    6. `chunkBlocks(blocks)` — split into API-sized batches
    Return chunked blocks and any accumulated warnings.

    Martian options (per research):
    ```javascript
    const martianOptions = {
      notionLimits: {
        truncate: false,  // Per user decision + research: never silently truncate
        onError: (error) => {
          warnings.push({ type: 'martian_limit', message: error.message });
        }
      },
      strictImageUrls: false  // Per research pitfall #5: invalid images become text
    };
    ```

    **`convertFile(filePath, options = {})`**
    Reads markdown file from disk, calls convertMarkdown, returns `{ fileName, blocks, chunks, warnings, blockCount }`.
    - `fileName`: basename of file for progress output
    - `blocks`: flat array of all blocks (pre-chunking, for dry-run inspection)
    - `chunks`: chunked arrays ready for API calls
    - `warnings`: array of warning objects
    - `blockCount`: total block count

    **`convertDirectory(dirPath, options = {})`**
    Processes all .md files in a directory (and subdirectories). Per user decision: directory-aware batch processing with file-level progress.
    - Discover all .md files using recursive directory walk (fs.readdirSync + recursive)
    - Sort files for deterministic order: PROJECT.md first, then ROADMAP.md, STATE.md, then phases in order
    - For each file: call convertFile, yield progress callback, accumulate results
    - Returns `{ files: ConversionResult[], totalBlocks, totalWarnings }`.

    Options parameter for all functions:
    ```javascript
    {
      dryRun: false,        // If true, skip API calls (Plan 03 doesn't make API calls anyway — Phase 8 does)
      onProgress: null,     // Callback: (fileName, index, total) => void
      logPath: null,        // Path for conversion log file (JSON Lines)
      cwd: process.cwd(),   // Working directory for sync-state operations
      projectSlug: null     // Project slug for sync-state tracking
    }
    ```

    **Conversion log (per user decision: lossy warnings in log file, console stays clean):**
    Write warnings to JSON Lines file at the path specified by `logPath` (default: `.planning/notion-sync.log`).
    Each line is a JSON object:
    ```json
    {"timestamp": "2026-02-11T10:30:00Z", "file": "RESEARCH.md", "type": "martian_limit", "message": "Rich text exceeded 2000 chars"}
    ```
    Append mode — don't overwrite previous log entries.

    **Incremental state tracking (per user decision: update per file for resume-on-error):**
    After each file converts successfully, if `options.projectSlug` is provided, update notion-sync.json with a conversion timestamp and block count for the file. This enables resume-on-error in Phase 8. Use `loadSyncState`/`saveSyncState` from sync-state.js.

    Store conversion metadata in a new `conversions` field per project:
    ```javascript
    state.projects[slug].conversions = {
      "ROADMAP.md": { convertedAt: "2026-02-11T10:30:00Z", blockCount: 45, chunks: 1 }
    };
    ```

    **Error handling:**
    - File read errors: log warning, skip file, continue with next
    - Martian conversion errors: catch, log as warning, wrap original markdown in code block as fallback (never lose content)
    - All errors are accumulated in warnings, not thrown (batch processing must continue)
  </action>
  <verify>
    Run `node -e "const {convertMarkdown} = require('./lib/notion/converter.js'); const result = convertMarkdown('# Test\\n\\nHello **world**'); console.log(JSON.stringify({chunks: result.blocks.length, warnings: result.warnings.length}))"` — outputs valid JSON with chunk count and zero warnings.

    Run `node -e "const {convertFile} = require('./lib/notion/converter.js'); const r = convertFile('.planning/ROADMAP.md'); console.log(r.fileName, r.blockCount, 'blocks', r.chunks.length, 'chunks')"` — shows ROADMAP.md conversion stats.

    Run `node -e "const {convertDirectory} = require('./lib/notion/converter.js'); const r = convertDirectory('.planning/', {onProgress: (f,i,t) => console.log('Converting ' + f + ' (' + (i+1) + '/' + t + ')...')}); console.log(r.files.length, 'files', r.totalBlocks, 'total blocks')"` — shows progress output and totals for all .planning/ files.
  </verify>
  <done>
    converter.js chains all pipeline stages (preprocess -> Martian -> text-split -> flatten -> toggle-convert -> chunk). convertMarkdown returns chunked blocks with warnings. convertFile reads from disk. convertDirectory processes all .md files with progress callbacks. Conversion log writes JSON Lines. State tracking updates per file. Errors accumulated as warnings without halting batch.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire converter into notion-sync.js CLI with convert subcommand</name>
  <files>bin/notion-sync.js</files>
  <action>
    Extend bin/notion-sync.js with a `convert` subcommand that exposes the converter module to the CLI.

    **New subcommand: `convert`**
    Usage: `node bin/notion-sync.js convert [path] [options]`
    - `path`: optional path to .md file or directory (default: `.planning/`)
    - `--dry-run`: show what would be converted without any side effects (no log file, no state updates)
    - `--cwd <path>`: working directory (existing flag)

    **Behavior:**
    1. Parse arguments for path, --dry-run, --cwd
    2. Determine if path is file or directory
    3. If file: call `convertFile(path, options)` and display results
    4. If directory: call `convertDirectory(path, options)` with progress callback

    **Progress output (per user decision: file-level progress):**
    ```
    Converting ROADMAP.md (1/8)... 45 blocks, 1 chunk
    Converting PROJECT.md (2/8)... 32 blocks, 1 chunk
    Converting phases/07.../07-RESEARCH.md (3/8)... 210 blocks, 3 chunks
    ...
    ✓ Conversion complete: 8 files, 523 total blocks, 12 chunks
    ```

    **Dry-run output (per user decision: shows what would be converted):**
    ```
    [DRY RUN] Would convert 8 files from .planning/

    ROADMAP.md — 45 blocks, 1 chunk
    PROJECT.md — 32 blocks, 1 chunk
    phases/07.../07-RESEARCH.md — 210 blocks, 3 chunks (⚠ 2 warnings)
    ...

    Total: 523 blocks across 12 chunks
    Warnings: 3 (see --verbose for details)
    ```

    If --dry-run, display block type breakdown per file (headings, paragraphs, lists, tables, code blocks, callouts, toggles, dividers, to_do) for visibility into what Martian produced.

    **Warning summary:**
    After conversion, if warnings exist, print count and path to log file:
    ```
    ⚠ 3 warnings written to .planning/notion-sync.log
    ```
    Do NOT print warning details to console (per user decision: console stays clean, log file gets details).

    **Update help text:**
    Add `convert` to the help output with description and examples:
    ```
    convert [path]  Convert .planning/ markdown to Notion blocks
    ```
    Add examples:
    ```
    node bin/notion-sync.js convert                          # Convert all .planning/ files
    node bin/notion-sync.js convert .planning/ROADMAP.md     # Convert single file
    node bin/notion-sync.js convert --dry-run                # Preview without side effects
    ```

    **Error handling:**
    - Invalid path: print error and exit 1
    - No .md files found: print info message and exit 0
    - Conversion errors: let converter handle (accumulates warnings), CLI shows summary
  </action>
  <verify>
    Run `node bin/notion-sync.js help` — shows convert command in help output.
    Run `node bin/notion-sync.js convert --dry-run` — shows dry-run output for .planning/ files without writing log or updating state.
    Run `node bin/notion-sync.js convert .planning/ROADMAP.md --dry-run` — shows single-file conversion preview.
    Run `node bin/notion-sync.js convert` — converts all .planning/ files, writes log if warnings exist, shows progress.
  </verify>
  <done>
    CLI has `convert` subcommand with file/directory support, --dry-run flag, file-level progress output, warning summary with log file path, and block type breakdown in dry-run mode. Help text updated with examples. Error handling follows existing CLI patterns.
  </done>
</task>

</tasks>

<verification>
1. `node bin/notion-sync.js convert --dry-run` — completes without error, shows all .planning/ files with block counts
2. `node bin/notion-sync.js convert .planning/ROADMAP.md --dry-run` — single file conversion preview
3. `node bin/notion-sync.js convert` — full conversion with progress output
4. Conversion log exists at .planning/notion-sync.log if warnings were generated
5. `node -e "const c = require('./lib/notion/converter.js'); console.log(Object.keys(c))"` — exports convertMarkdown, convertFile, convertDirectory
6. Custom XML tags in .planning/ files (e.g., 07-CONTEXT.md) appear as callout-compatible blocks in output
7. Large files produce multiple chunks (verify with RESEARCH.md which likely exceeds 90 blocks)
</verification>

<success_criteria>
- converter.js is an importable module with clean API for Phase 8 integration
- Full pipeline: preprocess -> Martian -> text-split -> flatten -> toggle-convert -> chunk
- CLI convert subcommand works for files and directories
- Dry-run mode shows conversion preview without side effects
- File-level progress output during batch processing
- Warnings logged to JSON Lines file (console stays clean)
- Incremental state tracking in notion-sync.json per file
- All .planning/ markdown files convert without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-markdown-to-notion-conversion/07-03-SUMMARY.md`
</output>
